 AS V1.42 Beta [Bld 216] - Source File floppy2_commented.asm - Page 1 - 02/21/2026 11:24:45 PM


       1/       0 :                     ; Ready to assemble with asl.
       2/       0 :                     ; Modified Version for use with extra ROM @ ED00
       3/       0 :                     ; Modifications are:
       4/       0 :                     ; - Runs on kees1948 CPUXXCMI Board with Exordisk Replica Board
       5/       0 :                     ; - Since there is literally no space left and the position of some labels is fixed
       6/       0 :                     ;   we put in JMPs to extra ROM @ ED00 and then JMP back to the appropriate place.
       7/       0 :                     ;****************************************************
       8/       0 :                     ; Used Labels
       9/       0 :                     ;****************************************************
      10/       0 :                     
      11/       0 : =$0                  CURDRV  EQU     $0000
      12/       0 : =$1                  STRSCTH EQU     $0001
      13/       0 : =$2                  STRSCTL EQU     $0002
      14/       0 : =$3                  NUMSCTH EQU     $0003
      15/       0 : =$4                  NUMSCTL EQU     $0004
      16/       0 : =$5                  LSCTLN  EQU     $0005
      17/       0 : =$6                  CURADRH EQU     $0006
      18/       0 : =$7                  CURADRL EQU     $0007
      19/       0 : =$8                  FDSTAT  EQU     $0008
      20/       0 : =$9                  CWRDCNT EQU     $0009
      21/       0 : =$A                  SofTRK  EQU     $000A
      22/       0 : =$B                  SECTCNT EQU     $000B
      23/       0 : =$D                  STATSAV EQU     $000D
      24/       0 : =$E                  FUNCSAV EQU     $000E
      25/       0 : =$F                  NMIVECSAV EQU   $000F
      26/       0 : =$10                 EXDSKSD EQU     $0010 ; Sides per disk (Single or double)
      27/       0 : =$12                 M0012   EQU     $0012 ; was: $11 and $12 are current Track of Drive 0,1, Reused always zero
      28/       0 : =$13                 TRACKSAV EQU    $0013 ; save the urrent track
      29/       0 : =$14                 ADDRMRK EQU     $0014
      30/       0 : =$15                 DWRDCNT EQU     $0015
      31/       0 : =$16                 STACKSAV EQU     $0016
      32/       0 : =$18                 DRDCNT  EQU     $0018
      33/       0 : =$19                 CLKFREQ EQU     $0019
      34/       0 : =$20                 LDADDR  EQU     $0020
      35/       0 : =$22                 EXADDR     EQU     $0022
      36/       0 : =$24                 ONECON     EQU     $0024
      37/       0 :                     
      38/       0 :                     ; The PIA has A0 and A1 switched!
      39/       0 :                     ; 00 with CRA2 Set is Peripheral Register A 
      40/       0 :                     ; 00 with CRA2 cleared is Data Direction Register A 
      41/       0 :                     ; 01 with CRB2 Set is Peripheral Register B 
      42/       0 :                     ; 01 with CRB2 cleared is Data Direction Register B 
      43/       0 :                     ; 02 is Control Register A
      44/       0 :                     ; 03 is Control Register B
      45/       0 : =$EC00               PIAREGA EQU     $EC00
      46/       0 : =$EC01               PIAREGB EQU     $EC01
      47/       0 : =$EC02               PIACTRL EQU     $EC02
      48/       0 : =$EC04               SSDA_0  EQU     $EC04
      49/       0 : =$EC05               SSDA_1  EQU     $EC05
      50/       0 : =$EC10               LPTPIA0 EQU     $EC10
      51/       0 : =$EC11               LPTPIA1 EQU     $EC11
      52/       0 : =$EC12               LPTPIA2 EQU     $EC12
      53/       0 : =$EC13               LPTPIA3 EQU     $EC13
      54/       0 :                     
      55/       0 : =$F018               XOUTCH  EQU     $F018
      56/       0 : =$F564               REENT2  EQU     $F564
      57/       0 : =$FCFC               PROM_0  EQU     $FCFC
      58/       0 : =$FF8A               XSTAKs  EQU     $FF8A
      59/       0 : =$FFFC               NMIsVC  EQU     $FFFC
      60/       0 :                     
 AS V1.42 Beta [Bld 216] - Source File floppy2_commented.asm - Page 2 - 02/21/2026 11:24:45 PM


      61/       0 :                     ; Printer
      62/       0 : =$EC10               MEC10   EQU     $EC10
      63/       0 : =$EC11               MEC11   EQU     $EC11
      64/       0 : =$EC12               MEC12   EQU     $EC12
      65/       0 : =$EC13               MEC13   EQU     $EC13
      66/       0 :                     
      67/       0 :                     ;****************************************************
      68/       0 :                     ; Program's Code Areas
      69/       0 :                     ;****************************************************
      70/       0 :                     
      71/       0 :                     
      72/    E800 :                                     ORG     $E800
      73/    E800 :                     
      74/    E800 : 8E FF 8A            OSLOAD          LDS     #XSTAKs                  ; E800: 8E FF 8A  ; Set Stackpointer     
      75/    E803 : 4F                                  CLRA                             ; E803: 4F        ; |    
      76/    E804 : 97 00                               STAA    CURDRV                   ; E804: 97 00     ; Set Drive to zero   
      77/    E806 : 8D 48                               BSR     FDINIT2                  ; E806: 8D 48     ; Init PIA and SSDA
      78/    E808 : 8D 6B                               BSR     RESTOR                   ; E808: 8D 6B     ; 
      79/    E80A : 8D 47                               BSR     CHKERR                   ; E80A: 8D 47     ; 
      80/    E80C : CE 00 17                            LDX     #$0017                   ; E80C: CE 00 17  ; Start at Sector $17 (Bootblock) (0xB80)
      81/    E80F : DF 01                               STX     STRSCTH                  ; E80F: DF 01     ; |
      82/    E811 : CE 00 02                            LDX     #$0002                   ; E811: CE 00 02  ; Get 2 sectors
      83/    E814 : DF 03                               STX     NUMSCTH                  ; E814: DF 03     ; |
      84/    E816 : CE 00 20                            LDX     #LDADDR                  ; E816: CE 00 20  ; Load @ 0x20
      85/    E819 : DF 06                               STX     CURADRH                  ; E819: DF 06     ; |
      86/    E81B : 8D 4C                               BSR     READSC                   ; E81B: 8D 4C     ; Read the Sector
      87/    E81D : 8D 34                               BSR     CHKERR                   ; E81D: 8D 34     ; Check for Error
      88/    E81F : 7E 00 20                            JMP     LDADDR                   ; E81F: 7E 00 20  ; Execute loaded code....
      89/    E822 :                     ;------------------------------------------------
      90/    E822 : 7E EB CF            FDINIT          JMP     FDINITEXT
      91/    E825 :                                     ;LDX     #$0000                   ; E822: CE 00 00  ; |
      92/    E825 : FF EC 02            FDINTBACK       STX     PIACTRL                  ; E825: FF EC 02  ; clr both control Reg.
      93/    E828 : FF EC 00                            STX     PIAREGA                  ; E828: FF EC 00  ; Set A and B to Input
      94/    E82B : CE D0 DA                            LDX     #$D0DA                   ; E82B: CE D0 DA  ; 
      95/    E82E : FF EC 04                            STX     SSDA_0                   ; E82E: FF EC 04  ; 
      96/    E831 : CE 04 04                            LDX     #$0404                   ; E831: CE 04 04  ; |
      97/    E834 : FF EC 02                            STX     PIACTRL                  ; E834: FF EC 02  ; Set A and B to Output Reg.
      98/    E837 : CE 1B 62                            LDX     #$1B62     ;changed      ; E837: CE 1B 02  ; |
      99/    E83A : FF EC 00                            STX     PIAREGA                  ; E83A: FF EC 00  ; Set DS0, DS1, DIRQ, HLD, WG, DS2, DS3(SIDE) high
     100/    E83D : CE 00 00                            LDX     #$0000                   ; E83D: CE 00 00  ; |
     101/    E840 : FF EC 02                            STX     PIACTRL                  ; E840: FF EC 02  ; Set both to Data direction Reg.
     102/    E843 : CE 1F 6F                            LDX     #$1F6F       ;changed    ; E843: CE 1F 0F  ; |
     103/    E846 : FF EC 00                            STX     PIAREGA                  ; E846: FF EC 00  ; PA0-PA4, PB0-PB3, PB5..6 Output
     104/    E849 : CE 3C 3E                            LDX     #$3C3E                   ; E849: CE 3C 3E  ; |
     105/    E84C : FF EC 02                            STX     PIACTRL                  ; E84C: FF EC 02  ; Select both Output Reg., Set CA2 (STEP), Set CB2 (NMI Timer), IRQB (IRQ) Set by LH Transition of CB1 (IDX)
     106/    E84F : 39                  ZE84F           RTS                              ; E84F: 39        ; Both Output Regsters Selected
     107/    E850 :                     ;------------------------------------------------
     108/    E850 : BD EB E7            FDINIT2         JSR     FDINIT3                  ; E850: BD EB A6  ; 
     109/    E853 :                     ;------------------------------------------------
     110/    E853 : 24 FA               CHKERR          BCC     ZE84F                    ; E853: 24 FA     ; no carry - no error
     111/    E855 : 8D 03               PRNTE2          BSR     PRNTER                   ; E855: 8D 03     ; Print for ex.: 'E2 ' for Error 0x32
     112/    E857 : 7E F5 64                            JMP     REENT2                   ; E857: 7E F5 64  ; 
     113/    E85A :                     ;------------------------------------------------
     114/    E85A : 86 45               PRNTER          LDAA    #$45                     ; E85A: 86 45      ; Load 'E'
     115/    E85C : 8D 08                               BSR     ZE866                    ; E85C: 8D 08      ; 
     116/    E85E : 96 08                               LDAA    FDSTAT                   ; E85E: 96 08      ; 
     117/    E860 : 8D 04                               BSR     ZE866                    ; E860: 8D 04      ; 
     118/    E862 : 86 20                               LDAA    #$20                     ; E862: 86 20      ; 
     119/    E864 : 8D 00                               BSR     ZE866                    ; E864: 8D 00      ; 
     120/    E866 : 7E F0 18            ZE866           JMP     XOUTCH                   ; E866: 7E F0 18   ; Print Accu A to Console
 AS V1.42 Beta [Bld 216] - Source File floppy2_commented.asm - Page 3 - 02/21/2026 11:24:45 PM


     121/    E869 :                     ;------------------------------------------------
     122/    E869 :                     ;READSC          LDAB    #$80                     ; E869: C6 80      ; 
     123/    E869 :                     ;                STAB    LSCTLN                   ; E86B: D7 05      ; 
     124/    E869 :                     ;READPS          CLRB                             ; E86D: 5F         ; 
     125/    E869 :                     ;                CPX     #MC640                   ; E86E: 8C C6 40   ; These CPX are just a method to deactivate the code after the LDAB
     126/    E869 :                     ;                CPX     #MC6C2                   ; E871: 8C C6 C2   ; These CPX are just a method to deactivate the code after the LDAB
     127/    E869 :                     ;                CPX     #MC608                   ; E874: 8C C6 08   ; These CPX are just a method to deactivate the code after the LDAB
     128/    E869 :                     ;                CPX     #MC610                   ; E877: 8C C6 10   ; These CPX are just a method to deactivate the code after the LDAB
     129/    E869 :                     ;                CPX     #MC682                   ; E87A: 8C C6 82   ; These CPX are just a method to deactivate the code after the LDAB
     130/    E869 :                     ;                CPX     #MC681                   ; E87D: 8C C6 81   ; These CPX are just a method to deactivate the code after the LDAB
     131/    E869 :                     ;                CPX     #MC6C0                   ; E880: 8C C6 C0   ; These CPX are just a method to deactivate the code after the LDAB
     132/    E869 :                     ;                CPX     #MC680                   ; E883: 8C C6 80   ; These CPX are just a method to deactivate the code after the LDAB
     133/    E869 :                     ;                CPX     #MC604                   ; E886: 8C C6 04   ; These CPX are just a method to deactivate the code after the LDAB
     134/    E869 :                     ;*************************************************
     135/    E869 :                     ; Meaning of the Bits in FUNCSAV:
     136/    E869 :                     ;
     137/    E869 :                     ; 7  6  5  4  3  2  1  0 
     138/    E869 :                     ; |  |  |  |  |  |  |  |-- 0: Write Deleted Address Mark (with bit 7 set)
     139/    E869 :                     ; |  |  |  |  |  |  |----- 1: test data from disk (with bit 7 set)
     140/    E869 :                     ; |  |  |  |  |  |-------- 2: measure the CPU Frequency via drive speed (these Bits are set alone)
     141/    E869 :                     ; |  |  |  |  |----------- 3: do a RESTOR (these Bits are set alone)
     142/    E869 :                     ; |  |  |  |-------------- 4: do a SEEK (these Bits are set alone)
     143/    E869 :                     ; |  |  |----------------- 5: not used
     144/    E869 :                     ; |  |-------------------- 6: do CRC Verify or read (can be set alone)
     145/    E869 :                     ; |----------------------- 7: write function (can be set alone)
     146/    E869 :                     ;
     147/    E869 :                     ;*************************************************
     148/    E869 : C6 80               READSC          LDAB    #$80                     ; E869: C6 80    ; NO Bit set    ; causes the number of sectors contained in NUMSCT beginning with STRSCT from CURDRV to be read into memory starting at the address contained in CURADR
     149/    E86B : D7 05                               STAB    LSCTLN                   ; E86B: D7 05 
     150/    E86D : 5F                  READPS          CLRB                             ; E86D: 5F       ; NO Bit set    ; similar to READSC with the exception that the last sector is only partially read according to the contents of LSCTLN
     151/    E86E : 8C                                  FCB     $8C
     152/    E86F : C6 40               RDCRC           LDAB    #$40                     ; E86F: C6 40    ; Bit 6 set     ; causes the number of sectors contained in NUMSCT beginning with STRSCT from CURDRV to be read to check their CRCs
     153/    E871 : 8C                                  FCB     $8C
     154/    E872 : C6 C2               RWTEST          LDAB    #$C2                     ; E872: C6 C2    ; Bit 7,6,1 set ; same as WRTEST + readback and check CRC
     155/    E874 : 8C                                  FCB     $8C
     156/    E875 : C6 08               RESTOR          LDAB    #$08                     ; E875: C6 08    ; Bit 3 set     ; causes the read/write head on CURDRV to be positioned to cylinder zero. The only parameter required is CURDRV.
     157/    E877 : 8C                                  FCB     $8C
     158/    E878 : C6 10               SEEK            LDAB    #$10                     ; E878: C6 10    ; Bit 4 set     ; causes the read/write head of CURDRV to be positioned to the cylinder containing STRSCT
     159/    E87A : 8C                                  FCB     $8C
     160/    E87B : C6 82               WRTEST          LDAB    #$82                     ; E87B: C6 82    ; Bit 7,1 set   ; causes the two bytes of data pointed to by the address in CURADR and the address+ 1 to be written to alternating bytes, respectively
     161/    E87D : 8C                                  FCB     $8C
     162/    E87E : C6 81               WRDDAM          LDAB    #$81                     ; E87E: C6 81    ; Bit 7,0 set   ; causes a deleted data address mark to be written
     163/    E880 : 8C                                  FCB     $8C
     164/    E881 : C6 C0               WRVERF          LDAB    #$C0                     ; E881: C6 C0    ; Bit 7,6 set   ; same as WRITSC + CRC Verify
     165/    E883 : 8C                                  FCB     $8C
     166/    E884 : C6 80               WRITSC          LDAB    #$80                     ; E884: C6 80    ; Bit 7 set     ; causes NUMSCT sectors beginning with STRSCT of CURDRV to be written from memory beginning at CURADR
     167/    E886 : 8C                                  FCB     $8C
     168/    E887 : C6 04               CLOCK           LDAB    #$04                     ; E887: C6 04    ; Bit 2 set     ; calculate clock frequency of CPU
     169/    E889 :                     
     170/    E889 : 07                                  TPA                              ; E889: 07         ; Transfer Status Reg to A
     171/    E88A : 0F                                  SEI                              ; E88A: 0F        ; 
     172/    E88B : 97 0D                               STAA    STATSAV                  ; E88B: 97 0D     ; Save Status Reg.
     173/    E88D : D7 0E                               STAB    FUNCSAV                  ; E88D: D7 0E     ; Save Function
     174/    E88F : 86 30                               LDAA    #$30                     ; E88F: 86 30     ; 
     175/    E891 : 97 08                               STAA    FDSTAT                   ; E891: 97 08     ; Clear Errors ('0')
     176/    E893 : 9F 16                               STS     STACKSAV                 ; E893: 9F 16     ; Set Stackpointer
     177/    E895 : FE FF FC                            LDX     NMIsVC                   ; E895: FE FF FC  ; |
     178/    E898 : DF 0F                               STX     NMIVECSAV                ; E898: DF 0F     ; Save old NMIISR
     179/    E89A : CE ED 33                            LDX     #NMIISR                  ; E89A: CE E9 39  ; |
     180/    E89D : FF FF FC                            STX     NMIsVC                   ; E89D: FF FF FC  ; New NMIISR
 AS V1.42 Beta [Bld 216] - Source File floppy2_commented.asm - Page 4 - 02/21/2026 11:24:45 PM


     181/    E8A0 :                     ;------------------------------------------------
     182/    E8A0 :                     ; from here new code
     183/    E8A0 :                     ;------------------------------------------------
     184/    E8A0 : 96 00                                LDAA    CURDRV
     185/    E8A2 : 81 04                                CMPA    #$04                     ; is CURDRV < 4
     186/    E8A4 : 24 4A                                BCC     SERR3                    ; if CURDRV > 3 Set Error 3
     187/    E8A6 : 84 03                                ANDA    #$03                     ; | mask dries > 3
     188/    E8A8 : B7 FE 05                             STAA    $FE05                    ; in $FE04,5 is a pointer to the variable for the current track / drive  
     189/    E8AB : 97 00                                STAA    CURDRV 
     190/    E8AD : B6 EC 00                             LDAA    PIAREGA                  ; Get PA0..7   
     191/    E8B0 : 84 EE                                ANDA    #$EE                     ; Mask DS0 and HLD (DEBUG Reset HLD while in floppy firmware and set it on exit)
     192/    E8B2 : D6 00                                LDAB    CURDRV                   ; Whats is the current drive
     193/    E8B4 : C4 01                                ANDB    #$01                     ; Mask Bit 0 for Drive 0 or 2
     194/    E8B6 : 27 02                                BEQ     DRVZRO                   ; Is it zero?
     195/    E8B8 : 8A 01                                ORAA     #$01                    ; If not Set PA0
     196/    E8BA :                                      ;LDAA    #$03                     ; If drive is NOT zero set PA0,1 high
     197/    E8BA : B7 EC 00            DRVZRO           STAA    PIAREGA                  ; Write TG43, DIRQ, HLD low, Set DS0, DS1 according to CURDRV (DS1 is NOT used)
     198/    E8BD : FE FE 04                             LDX     $FE04                    ; Get pointer
     199/    E8C0 : A6 00                                LDAA    ,X                       ; Get the Track of Drive
     200/    E8C2 : 97 13                                STAA    TRACKSAV                 ; Store it
     201/    E8C4 :                                      
     202/    E8C4 : B6 EC 01                             LDAA    PIAREGB                  ;
     203/    E8C7 :                                      ;ORAA    #$20                     ; Set WG and PB0(RESET) and DS2
     204/    E8C7 : 8A 60                                ORAA    #$60                     ; Set DS2 and DS3
     205/    E8C9 :                                      ;ANDA    #$BF                    ; DS3 low
     206/    E8C9 :                                      ;LDAA    #$62                     ; Set DS3(side) and DS2 high
     207/    E8C9 : D6 00                                LDAB    CURDRV                   ;
     208/    E8CB : C4 02                                ANDB    #$02                     ; Check if Drive 2 or 3 is set
     209/    E8CD : 27 02                                BEQ     STORE                    ; If Drive 0 or 1 is active, Leave DS2(PB5) High
     210/    E8CF : 84 DF                                ANDA    #$DF                     ; Set DS2 low
     211/    E8D1 : B7 EC 01            STORE            STAA    PIAREGB
     212/    E8D4 :                     
     213/    E8D4 : 86 40                               LDAA    #$40                     ; E8B4: 86 40     ; PA6 (RDY)
     214/    E8D6 : B5 EC 00            CHECKAGAIN      BITA    PIAREGA                  ; E8B6: B5 EC 00  ; Check Drive Ready
     215/    E8D9 : 26 FB                               BNE     CHECKAGAIN  ; changed
     216/    E8DB : B6 EC 00                            LDAA    PIAREGA
     217/    E8DE : 48                                  ASLA
     218/    E8DF : 48                                  ASLA
     219/    E8E0 : 97 10                               STAA    EXDSKSD                  ; Store PA5 (SIDES) in Bit 7 of M0010, high == SS
     220/    E8E2 : 2A 08                               BPL     TWOSIDED
     221/    E8E4 : B6 EC 01                            LDAA    PIAREGB                  ; This is needed because programs like format set SIDE low
     222/    E8E7 : 8A 40                               ORAA    #$40                     ; Set DS3 high again, it can't be low on SS disks
     223/    E8E9 : B7 EC 01                            STAA    PIAREGB                  ;
     224/    E8EC : D6 0E               TWOSIDED        LDAB    FUNCSAV     ; important!
     225/    E8EE : 20 08                               BRA     DRVRDY
     226/    E8F0 :                     ;------------------------------------------------
     227/    E8F0 :                     ; from here original code
     228/    E8F0 :                     ;------------------------------------------------
     229/    E8F0 :                     ;                BEQ     DRVRDY                   ; E8B9: 27 07     ; 
     230/    E8F0 : C6 33               SERR3           LDAB    #$33                     ; E8BB: C6 33     ; Error '3' (DISK NOT READY)
     231/    E8F2 :                     ;                CPX     #MC636                   ; E8BD: 8C C6 36  ; 
     232/    E8F2 : 8C                                  FCB     $8C
     233/    E8F3 : C6 36               SERR6           LDAB    #$36                                       ; Set Error '6' (INVALID DISK ADDRESS)
     234/    E8F5 : 7E ED 3A                            JMP     SETERR                   ; E8C0: 20 7E     ; 
     235/    E8F8 :                     ;                BRA     SETERR                   ; E8C0: 20 7E     ; 
     236/    E8F8 :                     ;------------------------------------------------
     237/    E8F8 : C5 08               DRVRDY          BITB    #$08                     ; E8C2: C5 08     ; Get Bit3 from FUNCSAV (RESTOR)
     238/    E8FA : 27 05                               BEQ     RESTORN                  ; E8C4: 27 05     ; Not RESTOR
     239/    E8FC : 5F                                  CLRB                             ; E8C6: 5F        ; 
     240/    E8FD : 86 03                               LDAA    #$03                     ; E8C7: 86 03     ; Go to Track 3
 AS V1.42 Beta [Bld 216] - Source File floppy2_commented.asm - Page 5 - 02/21/2026 11:24:45 PM


     241/    E8FF : 20 1A                               BRA     RESTORY                  ; E8C9: 20 3F          
     242/    E901 :                     ;------------------------------------------------
     243/    E901 : C5 04               RESTORN         BITB    #$04                     ; E8CB: C5 04     ; Get Bit2 from FUNCSAV (CLOCK)
     244/    E903 : 27 03                               BEQ     CLOCKN                   ; E8CD: 27 03     ; No Clock
     245/    E905 : 7E ED 00                            JMP     CLKDMD                   ; E8CF: 7E EB 85  ; Calculate CPU Freq., goes to CLKDMD, EXITHNDLR and RST
     246/    E908 :                     ;------------------------------------------------
     247/    E908 :                     ; check for number of (numsector + startsector) < 4004
     248/    E908 :                     ;------------------------------------------------
     249/    E908 : D6 02               CLOCKN          LDAB    STRSCTL                  ; E8D2: D6 02     ; normal code flow (no CLOCK, no RESTOR)
     250/    E90A : 96 01                               LDAA    STRSCTH                  ; E8D4: 96 01     ; Get Startsector
     251/    E90C : DB 04                               ADDB    NUMSCTL                  ; E8D6: DB 04     ; |
     252/    E90E : 99 03                               ADCA    NUMSCTH                  ; E8D8: 99 03     ; Add Number of sectors
     253/    E910 : 25 E1                               BCS     SERR6                    ; E8DA: 25 E2     ; Set Error '6': INVALID DISK ADDRESS
     254/    E912 :                                    ; CMPB    #$D3                     ; E8DC: C1 D3     ; |
     255/    E912 :                                    ; SBCA    #$07                     ; E8DE: 82 07     ; 0x7D3 = 2003 (sector too big)
     256/    E912 : C1 A4                               CMPB    #$A4     ;changed        ; E8DC: C1 D3     ; |
     257/    E914 : 82 0F                               SBCA    #$0F     ;changed        ; E8DE: 82 07     ; 0xFA4 = 4004 (sector too big)
     258/    E916 : 24 DB                               BCC     SERR6                    ; E8E0: 24 DC     ; Set Error '6': INVALID DISK ADDRESS
     259/    E918 :                     ;------------------------------------------------
     260/    E918 :                     ; Calculate Track for Sector Input
     261/    E918 :                     ;------------------------------------------------
     262/    E918 : BD ED 41                            JSR     CALCTRK
     263/    E91B :                     ;                LDAA    #$FF                     ; E8E2: 86 FF     ; 
     264/    E91B :                     ;                STAA    SofTRK                   ; E8E4: 97 0A     ; 
     265/    E91B :                     ;                LDAA    STRSCTH                  ; E8E6: 96 01     ; Startsector is usually at $17 at boot
     266/    E91B :                     ;                LDAB    STRSCTL                  ; E8E8: D6 02     ; |
     267/    E91B :                     ;IE8EA           INC     SofTRK                   ; E8EA: 7C 00 0A  ; is now at 0, if STARTSEC > $D0 increase
     268/    E91B :                     ;                SUBB    #$D0                     ; E8ED: C0 D0     ; 0xd0 = 208 (8 tracks exactly)
     269/    E91B :                     ;                SBCA    #$00                     ; E8EF: 82 00     ; 
     270/    E91B :                     ;                BCC     IE8EA                    ; E8F1: 24 F7     ; $17-$D0 is negative, carry is set
     271/    E91B :                     ;                ADDB    #$D0                     ; E8F3: CB D0     ; add $d0 again
     272/    E91B :                     ;                LDAA    SofTRK                   ; E8F5: 96 0A     ; is 0 or not if STARTSEC > $D0
     273/    E91B :                     ;                ASLA                             ; E8F7: 48        ; if SofTRK > 0 it means n*8 Tracks in
     274/    E91B :                     ;                ASLA                             ; E8F8: 48        ; 
     275/    E91B :                     ;                ASLA                             ; E8F9: 48        ; SofTRK * 8
     276/    E91B :                     ;                DECA                             ; E8FA: 4A        ; 
     277/    E91B :                     ;IE8FB           INCA                             ; E8FB: 4C        ; A is still 0 or TRACKS
     278/    E91B :                     ;                SUBB    #$1A                     ; E8FC: C0 1A     ; $1a = 26, is STRTSCT > 26
     279/    E91B :                     ;                BCC     IE8FB                    ; E8FE: 24 FB     ; add single Tracks now
     280/    E91B :                     ;                ADDB    #$1A                     ; E900: CB 1A     ; $1a = 26, if no add it again
     281/    E91B :                     ;                STAB    SofTRK                   ; E902: D7 0A     ; store it in Sector of Track (1-26)
     282/    E91B :                     ;                LDX     NUMSCTH                  ; E904: DE 03     ; A is Track wanted!
     283/    E91B :                     ;                STX     SECTCNT                  ; E906: DF 0B     ; 
     284/    E91B :                     ;                LDAB    TRACKSAV                 ; E908: D6 13     ; 
     285/    E91B :                     ;------------------------------------------------
     286/    E91B :                     ; actually STEP to Track
     287/    E91B :                     ;------------------------------------------------
     288/    E91B : 97 13               RESTORY         STAA    TRACKSAV                 ; E90A: 97 13     ; contains wanted track (A=3, B=0 if RESTOR or A=0, B=$56)
     289/    E91D : 10                                  SBA                              ; E90C: 10        ; B=0 if RESTOR so A-B=3 no carry, 0-$56 carry is set
     290/    E91E : F6 EC 00                            LDAB    PIAREGA                  ; E90D: F6 EC 00  ; 
     291/    E921 : CA 08                               ORAB    #$08                     ; E910: CA 08     ; Set Bit 3 (DIRQ - inverted) Step in
     292/    E923 : 24 03                               BCC     IE917                    ; E912: 24 03     ; B is Track now, A is wanted Track
     293/    E925 : C4 F7                               ANDB    #$F7                     ; E914: C4 F7     ; Clear Bit 3 (DIRQ - inverted) Step out
     294/    E927 : 40                                  NEGA                             ; E916: 40        ; If Result is negative, negate.
     295/    E928 :                     IE917           ;ANDB    #$EF                     ; E917: C4 EF     ; Isolate PA4 (HLD)
     296/    E928 :                                     ;CMPA    #$04                     ; E919: 81 04     ; Compare A with Track 4
     297/    E928 :                                     ;BLS     IE91F                    ; E91B: 23 02     ; 
     298/    E928 :                                     ;ORAB    #$10                     ; E91D: CA 10     ; Set Bit 4 (HLD)
     299/    E928 : F7 EC 00            IE91F           STAB    PIAREGA                  ; E91F: F7 EC 00  ; Write to Port
     300/    E92B : 4A                  STPAGAIN        DECA                             ; E922: 4A        ; 
 AS V1.42 Beta [Bld 216] - Source File floppy2_commented.asm - Page 6 - 02/21/2026 11:24:45 PM


     301/    E92C : 2B 3B                               BMI     ZE96A     ; -->          ; E923: 2B 45     ; done
     302/    E92E : 8D 15                               BSR     STEP                     ; E925: 8D 1F     ; Step once
     303/    E930 : F6 EC 00                            LDAB    PIAREGA                  ; E927: F6 EC 00  ; 
     304/    E933 : 2A F6                               BPL     STPAGAIN  ; changed      ; E92A: 2A EB     ; Bit 7 clear? Go again. (TRK0 is inverted, high == TRK0)
     305/    E935 :                                     ;BMI     IE917    ; changed       ; E92A: 2A EB     ; Bit 7 set? (TRK0)
     306/    E935 : 4D                                  TSTA                             ; E92C: 4D        ; 
     307/    E936 : 27 31                               BEQ     ZE96A     ; -->          ; E92D: 27 3B     ; done
     308/    E938 : 96 0E                               LDAA    FUNCSAV                  ; E92F: 96 0E     ; 
     309/    E93A : 85 08                               BITA    #$08                     ; E931: 85 08     ; Get Bit3 from FUNCSAV (RESTOR)
     310/    E93C : 27 04                               BEQ     SERR7                    ; E933: 27 09     ; Function is NOT RESTOR, Set Error
     311/    E93E : 8D 1B                               BSR     WAIT2                    ; E935: 8D 25     ; Wait
     312/    E940 : 20 4E                               BRA     EXITHNDLR ; -->          ; E937: 20 58     ; bail
     313/    E942 :                     ;------------------------------------------------
     314/    E942 :                     ;
     315/    E942 :                     ;------------------------------------------------
     316/    E942 : 7E ED 38            SERR7           JMP     xSERR7
     317/    E945 :                     ;NMIISR          LDS     STACKSAV                 ; E939: 9E 16     ; 
     318/    E945 :                     ;                LDAB    #$35                     ; E93B: C6 35     ; Set Error '5' (TIMEOUT)
     319/    E945 :                     ;;                CPX     #MC637                   ; E93D: 8C C6 37  ; 
     320/    E945 :                     ;                FCB     $8C
     321/    E945 :                     ;SERR7           LDAB    #$37                                       ; Set Error '7' (SEEK ERROR)
     322/    E945 :                     ;SETERR          STAB    FDSTAT                   ; E940: D7 08     ; 
     323/    E945 :                     ;                BSR     EXITHNDLR                ; E942: 8D 4D     ; 
     324/    E945 :                     ;                SEC                              ; E944: 0D        ; 
     325/    E945 :                     ;                RTS                              ; E945: 39        ; 
     326/    E945 :                     ;------------------------------------------------
     327/    E945 :                     ;
     328/    E945 :                     ;------------------------------------------------
     329/    E945 : C6 34               STEP            LDAB    #$34                     ; E946: C6 34     ; Bit 5,4,2 set
     330/    E947 : F7 EC 02                            STAB    PIACTRL                  ; E948: F7 EC 02  ; CA2 low (STEP)
     331/    E94A : C6 3C                               LDAB    #$3C                     ; E94B: C6 3C     ; Bit 5,4,3,2 set
     332/    E94C : F7 EC 02                            STAB    PIACTRL                  ; E94D: F7 EC 02  ; CA2 high (STEP)
     333/    E94F : CE 00 FE                            LDX     #$00FE                   ; E950: CE 00 FE  ; 
     334/    E952 : D6 19               WAIT3           LDAB    CLKFREQ                  ; E953: D6 19     ; is 3 for 1MHz
     335/    E954 : 5A                  WAIT1           DECB                             ; E955: 5A        ; 
     336/    E955 : 26 FD                               BNE     WAIT1                    ; E956: 26 FD     ; 
     337/    E957 : 09                                  DEX                              ; E958: 09        ; 
     338/    E958 : 26 F8                               BNE     WAIT3                    ; E959: 26 F8     ; 
     339/    E95A : 39                                  RTS                              ; E95B: 39        ; 
     340/    E95B :                     ;------------------------------------------------
     341/    E95B : CE 01 87            WAIT2           LDX     #$0187                   ; E95C: CE 01 87  ; 
     342/    E95E : 20 F2                               BRA     WAIT3                    ; E95F: 20 F2     ; 
     343/    E960 :                     ;------------------------------------------------
     344/    E960 : 96 13               IE961           LDAA    TRACKSAV                 ; E961: 96 13     ; Function = RESTOR
     345/    E962 : 27 DE                               BEQ     SERR7                    ; E963: 27 D9     ; Is Track 0? If yes Set Error '7' (SEEK ERROR)
     346/    E964 : 4F                                  CLRA                             ; E965: 4F        ; 
     347/    E965 : C6 56                               LDAB    #86                      ; E966: C6 56     ; = 86 <---- What is this??????
     348/    E967 : 20 B2                               BRA     RESTORY   ; -->          ; E968: 20 A0     ; 
     349/    E969 :                     ;------------------------------------------------
     350/    E969 :                     ; Comes from RESTORY
     351/    E969 :                     ;------------------------------------------------
     352/    E969 : CE 02 C0            ZE96A           LDX     #$02C0                   ; E96A: CE 02 C0  ; |
     353/    E96C : 8D E4                               BSR     WAIT3                    ; E96D: 8D E4     ; Wait
     354/    E96E : 96 0E                               LDAA    FUNCSAV                  ; E96F: 96 0E     ; What was the function?
     355/    E970 : 85 08                               BITA    #$08                     ; E971: 85 08     ; Is Function = RESTOR ?
     356/    E972 : 26 EC                               BNE     IE961                    ; E973: 26 EC     ; if yes, branch
     357/    E974 : 85 10                               BITA    #$10                     ; E975: 85 10     ; Is FUNCTION SEEK?
     358/    E976 : 26 18                               BNE     EXITHNDLR                ; E977: 26 18     ; If yes - Done
     359/    E978 : C6 6F                               LDAB    #$6F                     ; E979: C6 6F     ; Write Sync data address mark
     360/    E97A : 46                                  RORA                             ; E97B: 46        ; Get Bit 0 of Function into carry
 AS V1.42 Beta [Bld 216] - Source File floppy2_commented.asm - Page 7 - 02/21/2026 11:24:45 PM


     361/    E97B : 24 02                               BCC     IE980                    ; E97C: 24 02     ; Is Bit 0 set?
     362/    E97D : C6 6A                               LDAB    #$6A                     ; E97E: C6 6A     ; yes, write DELETED DATA MARK (WRDDAM)
     363/    E97F : D7 14               IE980           STAB    ADDRMRK                  ; E980: D7 14     ; 
     364/    E981 :                                     ;LDAB    PIAREGA     ;changed     ; 
     365/    E981 :                                     ;ORAB    #$08        ;changed     ; Step in
     366/    E981 :                                     ;STAB    PIAREGA     ;changed     ; 
     367/    E981 : 20 60                               BRA     NXTSEC                   ; E982: 20 4F     ; next sector
     368/    E983 :                     ;------------------------------------------------
     369/    E983 :                     ; Comes from NXTSEC
     370/    E983 :                     ;------------------------------------------------
     371/    E983 : 96 0E               SECRDDONE       LDAA    FUNCSAV                  ; E984: 96 0E     ; Get Function
     372/    E985 : 2A 09                               BPL     EXITHNDLR                ; E986: 2A 09     ; Bit 7 not Set - done (READPS, RDCRC, RESTOR, SEEK, CLOCK)
     373/    E987 : 84 40                               ANDA    #$40                     ; E988: 84 40     ; Isolate Bit 6
     374/    E989 : 97 0E                               STAA    FUNCSAV                  ; E98A: 97 0E     ; <------------- WHY??
     375/    E98B : 27 03                               BEQ     EXITHNDLR                ; E98C: 27 03     ; Bit 6 NOT set - done (READSC, WRTEST, WRDDAM, WRITSC)
     376/    E98D : 7E E9 08                            JMP     CLOCKN                   ; E98E: 7E E8 D2  ; Bit 6 Set (normal codeflow) (RWTEST, WRVERF)
     377/    E990 :                     ;------------------------------------------------
     378/    E990 :                     ;
     379/    E990 :                     ;------------------------------------------------
     380/    E990 : B6 EC 00            EXITHNDLR       LDAA    PIAREGA                  ; 
     381/    E993 : 8A 10                               ORAA    #$10                     ; Set Bit 4 (HLD)
     382/    E995 : B7 EC 00                            STAA    PIAREGA                  ; 
     383/    E998 :                     ;                LDX     #$433C     ;changed 
     384/    E998 :                     ;                LDAA    PIAREGB
     385/    E998 :                     ;                BITA    #$20                     ; check for drive 2 or 3
     386/    E998 :                     ;                BEQ     DRIVETHREE               ; if zero we are on drive >1
     387/    E998 :                     ;                LDX     #$633C    ;changed      ; E991: CE 03 3C  ; |
     388/    E998 :                     ;DRIVETHREE      STX     PIAREGB   ;write PIAREGB, changed   ; E994: FF EC 01  ; Set PB0,1,5,6 (RESET, DS2, DS3, WG) and Select A Output Reg., Set CA2 (STEP)
     389/    E998 :                     ;                LDX     NMIVECSAV                ; E997: DE 0F     ; |
     390/    E998 :                     ;                STX     NMIsVC                   ; E999: FF FF FC  ; Restore old NMIISR
     391/    E998 : 86 3C                               LDAA    #$3C
     392/    E99A : B7 EC 02                            STAA    PIACTRL
     393/    E99D : 86 43                               LDAA    #$43
     394/    E99F : B6 EC 01                            LDAA    PIAREGB
     395/    E9A2 : 85 20                               BITA    #$20                     ; check for drive 2 or 3
     396/    E9A4 : 27 02                               BEQ     DRIVETHREE               ; if zero we are on drive >1
     397/    E9A6 : 86 63                               LDAA    #$63
     398/    E9A8 : B7 EC 01            DRIVETHREE      STAA    PIAREGB   ;write PIAREGB,  Set PB0,1,5,6 (RESET, DS2, DS3, WG)
     399/    E9AB : DE 0F                               LDX     NMIVECSAV                ; E997: DE 0F     ; |
     400/    E9AD : FF FF FC                            STX     NMIsVC                   ; E999: FF FF FC  ; Restore old NMIISR
     401/    E9B0 :                     ;------------------------------------------------
     402/    E9B0 :                     ; from here new code
     403/    E9B0 :                     ;------------------------------------------------                
     404/    E9B0 : 96 00                               LDAA    CURDRV                  ; 
     405/    E9B2 : B7 FE 05                            STAA    $FE05                   ; 
     406/    E9B5 : FE FE 04                            LDX     $FE04                   ; 
     407/    E9B8 : 96 13                               LDAA    TRACKSAV                ; 
     408/    E9BA : A7 00                               STAA    ,X                      ; 
     409/    E9BC :                     ;------------------------------------------------
     410/    E9BC :                     ; from here original code
     411/    E9BC :                     ;------------------------------------------------
     412/    E9BC : 96 0D                               LDAA    STATSAV
     413/    E9BE : 06                                  TAP                              ; E9A9: 06        ; Transfer A to Status Register
     414/    E9BF : 0C                                  CLC                              ; E9AA: 0C        ; 
     415/    E9C0 : 39                                  RTS                              ; E9AB: 39        ; 
     416/    E9C1 :                     ;------------------------------------------------
     417/    E9C1 :                     ; NXTSEC:
     418/    E9C1 :                     ; if sector >= 27 - steps to next Track,
     419/    E9C1 :                     ; updates SECTCNT, SofTRK, CWRDCNT, DWRDCNT
     420/    E9C1 :                     ;------------------------------------------------
 AS V1.42 Beta [Bld 216] - Source File floppy2_commented.asm - Page 8 - 02/21/2026 11:24:45 PM


     421/    E9C1 : D6 10               INCSIDE         LDAB    EXDSKSD  ;  Bit 7 high == SS
     422/    E9C3 : 2B 0C                               BMI     INCTRK                   ;
     423/    E9C5 : F6 EC 01                            LDAB    PIAREGB                  ; 
     424/    E9C8 : C4 BF                               ANDB    #$BF                     ; Reset Side (= Side 1)
     425/    E9CA : F7 EC 01                            STAB    PIAREGB                  ; 
     426/    E9CD : 80 1A                               SUBA    #26                      ; We have Sector 27 - 27 = 0 - 26 carry is set, for 53-27=26-26 carry is clear
     427/    E9CF : 25 1F                               BCS     SIDETWO
     428/    E9D1 :                                     ;LDAA    #$FF
     429/    E9D1 :                                     ;ADDA    #26
     430/    E9D1 : 97 0A               INCTRK          STAA    SofTRK                   ; E9CA: 97 0A     ; store new Sector of Track
     431/    E9D3 : BD E9 45                            JSR     STEP                     ; E9CC: BD E9 46  ; move to next Track (X = 0)
     432/    E9D6 : B6 EC 01                            LDAA    PIAREGB
     433/    E9D9 : 8A 40                               ORAA    #$40                     ; Set Side high ( = Side 0)
     434/    E9DB : B7 EC 01                            STAA    PIAREGB
     435/    E9DE :                                     ;BSR     WAIT2                    ; E9CF: 8D 8B     ; wait some more (X = 0)
     436/    E9DE : BD E9 5B                            JSR     WAIT2    ;changed         ; E9CF: 8D 8B     ; wait some more (X = 0)
     437/    E9E1 : 6C 13                               INC     $13,X                    ; E9D1: 6C 13     ; increment TRACKSAV
     438/    E9E3 : 7C 00 0A            NXTSEC          INC     SofTRK                   ; E9D3: 7C 00 0A  ; increment Sector of Track
     439/    E9E6 : 96 0A                               LDAA    SofTRK                   ; E9D6: 96 0A     ; Load it to A
     440/    E9E8 : DE 0B                               LDX     SECTCNT                  ; E9D8: DE 0B     ; Load Sector count
     441/    E9EA : 27 97                               BEQ     SECRDDONE   ; -->        ; E9DA: 27 A8     ; done?
     442/    E9EC : 80 1B                               SUBA    #27                     ; E9DC: 80 1B     ; Sector == 27?
     443/    E9EE : 24 D1                               BCC     INCSIDE
     444/    E9F0 :                                     ;BCC     INCTRK                   ; E9DE: 24 EA     ; increase Track
     445/    E9F0 :                     
     446/    E9F0 : 86 05               SIDETWO         LDAA    #$05                     ; E9E0: 86 05     ; 
     447/    E9F2 : 97 18                               STAA    DRDCNT                   ; E9E2: 97 18     ; Data Read Counter
     448/    E9F4 : 09                                  DEX                              ; E9E4: 09        ; decrement sectorcount
     449/    E9F5 : 86 40               START           LDAA    #$40                     ; E9E5: 86 40     ; One Sector is $40 words
     450/    E9F7 : DF 0B                               STX     SECTCNT                  ; E9E7: DF 0B     ; store updated sectorcount
     451/    E9F9 : 26 07                               BNE     IE9F2                    ; E9E9: 26 07     ; not done, jump
     452/    E9FB : 96 05                               LDAA    LSCTLN                   ; E9EB: 96 05     ; LAST SofTRK LENGTH (1-128)
     453/    E9FD : 8B 07                               ADDA    #$07                     ; E9ED: 8B 07     ; isolate Bit 0,1,2
     454/    E9FF : 44                                  LSRA                             ; E9EF: 44        ; convert to words
     455/    EA00 : 84 FC                               ANDA    #$FC                     ; E9F0: 84 FC     ; isolate Bit 0,1
     456/    EA02 : 97 15               IE9F2           STAA    DWRDCNT                  ; E9F2: 97 15     ; is $40 for every full sector
     457/    EA04 : 40                                  NEGA                             ; E9F4: 40        ; 
     458/    EA05 : D6 0E                               LDAB    FUNCSAV                  ; E9F5: D6 0E     ; 
     459/    EA07 : 58                                  ASLB                             ; E9F7: 58        ; Check Bit 6 (RDCRC, RWTEST, WRVERF)
     460/    EA08 : 2A 01                               BPL     NOCRC                    ; E9F8: 2A 01     ; if not set, jump
     461/    EA0A : 4F                                  CLRA                             ; E9FA: 4F        ; 
     462/    EA0B : 8B 40               NOCRC           ADDA    #$40                     ; E9FB: 8B 40     ; 
     463/    EA0D : 97 09                               STAA    CWRDCNT                  ; E9FD: 97 09     ; 
     464/    EA0F : BD ED 22                            JSR     RETRG                    ; E9FF: BD EB 74  ; Retrigger NMI Timer X <- EC00
     465/    EA12 :                                     ;LDAA    TRACKSAV ;changed       ; EA02: 96 13     ; 
     466/    EA12 :                                     ;ORAB    #$0C     ;changed       ; EA04: CA 0C     ; In B is FUNCSAV<<1, isol. Bit 2,3 (RWTEST, WRTEST, CLOCK)
     467/    EA12 :                                     ;CMPA    #$2B     ;changed       ; EA06: 81 2B     ; check for Track > 43
     468/    EA12 :                                     ;BLS     IEA0C    ;changed       ; EA08: 23 02     ; No
     469/    EA12 :                                     ;ANDB    #$FB     ;changed       ; EA0A: C4 FB     ; Clr Bit 2 (CLOCK, and TG43 on PA2)
     470/    EA12 :                     IEA0C           ;STAB    ,X       ;changed       ; EA0C: E7 00     ; Set PortA
     471/    EA12 : CE D2 70                            LDX     #$D270                   ; EA0E: CE D2 70  ; Inhibit: Sync,Tx,Rx,Select CR3 and 1 Sync Character,Internal Sync,Clear: TUF,CTS
     472/    EA15 : FF EC 04                            STX     SSDA_0                   ; EA11: FF EC 04  ; |
     473/    EA18 : CE D1 F5                            LDX     #$D1F5                   ; EA14: CE D1 F5  ; Select Sync Code Register and Set Sync Code to hex F5
     474/    EA1B : FF EC 04                            STX     SSDA_0                   ; EA17: FF EC 04  ; |
     475/    EA1E :                     ;*************************************************
     476/    EA1E :                     ; Looking for ID Addr. Mark, correct Track and Sector
     477/    EA1E :                     ;*************************************************
     478/    EA1E : BD EB 9B            IEA1A           JSR     READINIT  ;changed ; EA1A: 8D 90     ; X is on PIAREGA (EC00), Toggle RESET
     479/    EA21 : A6 04               IEA1C           LDAA    $04,X                    ; EA1C: A6 04     ; Read SSDA Status Reg.
     480/    EA23 : 2A FC                               BPL     IEA1C                    ; EA1E: 2A FC     ; Wait for Data
 AS V1.42 Beta [Bld 216] - Source File floppy2_commented.asm - Page 9 - 02/21/2026 11:24:45 PM


     481/    EA25 : A6 05                               LDAA    $05,X                    ; EA20: A6 05     ; Read SSDA Data Reg
     482/    EA27 : 81 7E                               CMPA    #$7E                     ; EA22: 81 7E     ; ID address mark ?
     483/    EA29 : 26 F3                               BNE     IEA1A                    ; EA24: 26 F4     ; No ?, Try again.
     484/    EA2B : A6 04               IEA26           LDAA    $04,X                    ; EA26: A6 04     ; *********** Found Id Addr. Mark ***********
     485/    EA2D : 2A FC                               BPL     IEA26                    ; EA28: 2A FC     ; Wait for Data
     486/    EA2F : A6 05                               LDAA    $05,X                    ; EA2A: A6 05     ; Read SSDA Data Reg into A
     487/    EA31 : E6 05                               LDAB    $05,X                    ; EA2C: E6 05     ; Read SSDA Data Reg into B
     488/    EA33 : 91 13                               CMPA    TRACKSAV                 ; EA2E: 91 13     ; Compare with Track
     489/    EA35 : 26 E7                               BNE     IEA1A                    ; EA30: 26 E8     ; Try again
     490/    EA37 : A6 04               IEA32           LDAA    $04,X                    ; EA32: A6 04     ; We are on the right Track, Read SSDA Status Reg.
     491/    EA39 : 2A FC                               BPL     IEA32                    ; EA34: 2A FC     ; Wait for Data
     492/    EA3B : A6 05                               LDAA    $05,X                    ; EA36: A6 05     ; Read SSDA Data Reg into A
     493/    EA3D : E6 05                               LDAB    $05,X                    ; EA38: E6 05     ; Read SSDA Data Reg into B
     494/    EA3F : 91 0A                               CMPA    SofTRK                   ; EA3A: 91 0A     ; Compare with sector
     495/    EA41 : 26 DB                               BNE     IEA1A                    ; EA3C: 26 DC     ; Try again
     496/    EA43 : A6 04               IEA3E           LDAA    $04,X                    ; EA3E: A6 04     ; Found Sector, Read SSDA Status Reg.
     497/    EA45 : 2A FC                               BPL     IEA3E                    ; EA40: 2A FC     ; Wait for Data
     498/    EA47 : 6D 05                               TST     $05,X                    ; EA42: 6D 05     ; SSDA Data Reg
     499/    EA49 : 96 19                               LDAA    CLKFREQ                  ; EA44: 96 19     ; 
     500/    EA4B : 80 03               IEA46           SUBA    #$03                     ; EA46: 80 03     ; 
     501/    EA4D : 22 FC                               BHI     IEA46                    ; EA48: 22 FC     ; 
     502/    EA4F : A6 01                               LDAA    $01,X                    ; EA4A: A6 01     ; Read PIAREGB
     503/    EA51 : 2B 3B                               BMI     SERR9                    ; EA4C: 2B 3B     ; PB7 High ? (CRC-0) - ERROR
     504/    EA53 :                     ;*************************************************
     505/    EA53 :                     ; Found corr. Track and Sector, now look for Data Addr. Mark
     506/    EA53 :                     ;*************************************************
     507/    EA53 : A6 05                               LDAA    $05,X                    ; EA4E: A6 05     ; 
     508/    EA55 : 86 04                               LDAA    #$04                     ; EA50: 86 04     ; Try four times
     509/    EA57 : 6D 04               IEA52           TST     $04,X                    ; EA52: 6D 04     ; Read SSDA Status Reg.
     510/    EA59 : 2A FC                               BPL     IEA52                    ; EA54: 2A FC     ; Wait for Data
     511/    EA5B : A1 05                               CMPA    $05,X                    ; EA56: A1 05     ; Compare SSDA Data Reg to A (04)
     512/    EA5D : A1 05                               CMPA    $05,X                    ; EA58: A1 05     ; Compare SSDA Data Reg to A (04)
     513/    EA5F : 4A                                  DECA                             ; EA5A: 4A        ; |
     514/    EA60 : 26 F5                               BNE     IEA52                    ; EA5B: 26 F5     ; try again
     515/    EA62 : D6 0E                               LDAB    FUNCSAV                  ; EA5D: D6 0E     ; 
     516/    EA64 : 2B 7C                               BMI     WRITINI2   ; -->         ; EA5F: 2B 7C     ; Bit 7 set - Write Function
     517/    EA66 : D6 19                               LDAB    CLKFREQ                  ; EA61: D6 19     ; Waitloop
     518/    EA68 : 58                                  ASLB                             ; EA63: 58        ; |
     519/    EA69 : 08                  IEA64           INX                              ; EA64: 08        ; |
     520/    EA6A : 09                                  DEX                              ; EA65: 09        ; |
     521/    EA6B : 5A                                  DECB                             ; EA66: 5A        ; |
     522/    EA6C : 26 FB                               BNE     IEA64                    ; EA67: 26 FB     ; |
     523/    EA6E : C6 04                               LDAB    #$04                     ; EA69: C6 04     ; Try four times
     524/    EA70 : BD EB 9B            IEA6B           JSR     READINIT                 ; EA6B: BD E9 AC  ; Initialize SSDA for Read, Toggle RESET
     525/    EA73 : DE 06                               LDX     CURADRH                  ; EA6E: DE 06     ; Load Start Address
     526/    EA75 : B6 EC 04            IEA70           LDAA    SSDA_0                   ; EA70: B6 EC 04  ; Read SSDA Status Reg.
     527/    EA78 : 2A FB                               BPL     IEA70                    ; EA73: 2A FB     ; Wait and Test RDA for 2 Bytes Ready
     528/    EA7A : B6 EC 05                            LDAA    SSDA_1                   ; EA75: B6 EC 05  ; Read Data
     529/    EA7D : 81 6F                               CMPA    #$6F                     ; EA78: 81 6F     ; Sync data address mark
     530/    EA7F : 27 21                               BEQ     READSECT  ; -->          ; EA7A: 27 21     ; ********** Found data address mark *************
     531/    EA81 : 81 6A                               CMPA    #$6A                     ; EA7C: 81 6A     ; Read DELETED DATA MARK (set Error '4')
     532/    EA83 : 27 18                               BEQ     SERR4                    ; EA7E: 27 18     ; |
     533/    EA85 : 5A                                  DECB                             ; EA80: 5A        ; |
     534/    EA86 : 26 E8                               BNE     IEA6B                    ; EA81: 26 E8     ; again
     535/    EA88 : C6 38                               LDAB    #$38                     ; EA83: C6 38     ; (Set Error '8') (DATA MARK ERROR)
     536/    EA8A :                     ;                CPX     #MC631                   ; EA85: 8C C6 31  ; 
     537/    EA8A : 8C                                  FCB     $8C
     538/    EA8B : C6 31               SERR1           LDAB    #$31                                       ; (Set Error '1') (DATA CRC ERROR)
     539/    EA8D :                     ;                CPX     #MC639                   ; EA88: 8C C6 39  ; 
     540/    EA8D : 8C                                  FCB     $8C
 AS V1.42 Beta [Bld 216] - Source File floppy2_commented.asm - Page 10 - 02/21/2026 11:24:45 PM


     541/    EA8E : C6 39               SERR9           LDAB    #$39                                        ; (Set Error '9') (ADDRESS MARK CRC ERROR)
     542/    EA90 : 7A 00 18                            DEC     DRDCNT                   ; EA8B: 7A 00 18  ; decrement counter (was 5)
     543/    EA93 : 27 0A                               BEQ     IEA9A                    ; EA8E: 27 0A     ; if 0, set error
     544/    EA95 : DE 0B                               LDX     SECTCNT                  ; EA90: DE 0B     ; if not, try again
     545/    EA97 : 7E E9 F5                            JMP     START      ; -->         ; EA92: 7E E9 E5  ; 
     546/    EA9A :                     ;------------------------------------------------
     547/    EA9A : C6 32               SERR2           LDAB    #$32                     ; EA95: C6 32     ; Set Error '2' (DISK WRITE PROTECTED)
     548/    EA9C :                     ;                CPX     #MC634                   ; EA97: 8C C6 34  ; 
     549/    EA9C : 8C                                  FCB     $8C
     550/    EA9D : C6 34               SERR4           LDAB    #$34                                        ; (Set Error '4') (READ DELETED DATA MARK)
     551/    EA9F : 7E ED 3A            IEA9A           JMP     SETERR     ; -->         ; EA9A: 7E E9 40  ; 
     552/    EAA2 :                     ;------------------------------------------------
     553/    EAA2 : D6 0E               READSECT        LDAB    FUNCSAV                  ; EA9D: D6 0E     ; data address mark found
     554/    EAA4 : 58                                  ASLB                             ; EA9F: 58        ; FUNCSAV<<1
     555/    EAA5 : 2B 19                               BMI     CRCONLY                  ; EAA0: 2B 19     ; Check for READCRC ($40, Bit 6)
     556/    EAA7 : D6 15                               LDAB    DWRDCNT                  ; EAA2: D6 15     ; Data Wordcount
     557/    EAA9 : B6 EC 04            IEAA4           LDAA    SSDA_0                   ; EAA4: B6 EC 04  ; Read SSDA Status Reg.
     558/    EAAC : 2A FB                               BPL     IEAA4                    ; EAA7: 2A FB     ; Wait and Test RDA for 2 Bytes Ready
     559/    EAAE : B6 EC 05                            LDAA    SSDA_1                   ; EAA9: B6 EC 05  ; Read Data to Buffer
     560/    EAB1 : BC FC FC                            CPX     PROM_0                   ; EAAC: BC FC FC  ; X is on $20, in PROM_0 is zero *** This does nothing ! ***
     561/    EAB4 : A7 00                               STAA    ,X                       ; EAAF: A7 00     ; |
     562/    EAB6 : B6 EC 05                            LDAA    SSDA_1                   ; EAB1: B6 EC 05  ; |
     563/    EAB9 : A7 01                               STAA    $01,X                    ; EAB4: A7 01     ; |
     564/    EABB : 08                                  INX                              ; EAB6: 08        ; |
     565/    EABC : 08                                  INX                              ; EAB7: 08        ; |
     566/    EABD : 5A                                  DECB                             ; EAB8: 5A        ; |
     567/    EABE : 26 E9                               BNE     IEAA4                    ; EAB9: 26 E9     ; 
     568/    EAC0 : D6 09               CRCONLY         LDAB    CWRDCNT                  ; EABB: D6 09     ; CRC Wordcount
     569/    EAC2 : B6 EC 04            READCRC         LDAA    SSDA_0                   ; EABD: B6 EC 04  ; Read SSDA Status Reg.
     570/    EAC5 : 2A FB                               BPL     READCRC                  ; EAC0: 2A FB     ; Wait and Test RDA for 2 Bytes Ready
     571/    EAC7 : 5A                                  DECB                             ; EAC2: 5A        ; dec. counter
     572/    EAC8 : 2B 08                               BMI     CRCOK                    ; EAC3: 2B 08     ; finished ?
     573/    EACA : B6 EC 05                            LDAA    SSDA_1                   ; EAC5: B6 EC 05  ; Read SSDA Data to A
     574/    EACD : B6 EC 05                            LDAA    SSDA_1                   ; EAC8: B6 EC 05  ; Read SSDA Data to A
     575/    EAD0 : 20 F0                               BRA     READCRC                  ; EACB: 20 F0     ; continue
     576/    EAD2 :                     
     577/    EAD2 : 96 19               CRCOK           LDAA    CLKFREQ                  ; EACD: 96 19     ; 
     578/    EAD4 : 80 03               IEACF           SUBA    #$03                     ; EACF: 80 03     ; 
     579/    EAD6 : 22 FC                               BHI     IEACF                    ; EAD1: 22 FC     ; 
     580/    EAD8 : B6 EC 01                            LDAA    PIAREGB                  ; EAD3: B6 EC 01  ; |
     581/    EADB : 2B AE                               BMI     SERR1                    ; EAD6: 2B AE     ; PB7 High ? (CRC-0) Error
     582/    EADD : DF 06                               STX     CURADRH                  ; EAD8: DF 06     ; CRC ok
     583/    EADF : 7E E9 E3                            JMP     NXTSEC     ; -->         ; EADA: 7E E9 D3  ; next sector
     584/    EAE2 :                     ;------------------------------------------------
     585/    EAE2 :                     ; from here new code
     586/    EAE2 :                     ;------------------------------------------------                
     587/    EAE2 : CE C0 DA            WRITINI2        LDX     #$C0DA                   ; EADD: CE C0 DA  ; 
     588/    EAE5 : FF EC 04                            STX     SSDA_0                   ; EAE0: FF EC 04  ; 
     589/    EAE8 : CE C1 AA                            LDX     #$C1AA                   ; EAE3: CE C1 AA  ; 
     590/    EAEB : FF EC 04                            STX     SSDA_0                   ; EAE6: FF EC 04  ; 
     591/    EAEE : CE C2 70                            LDX     #$C270                   ; EAE9: CE C2 70  ; 
     592/    EAF1 : FF EC 04                            STX     SSDA_0                   ; EAEC: FF EC 04  ; 
     593/    EAF4 : 7C EC 01                            INC     PIAREGB  ;write PIAREGB  ; EAEF: 7C EC 01  ; Reset inactive (PB0 high)
     594/    EAF7 : 86 82                               LDAA    #$82                     ; EAF2: 86 82     ; Bit 1,7
     595/    EAF9 : B7 EC 04                            STAA    SSDA_0                   ; EAF4: B7 EC 04  ; RXRs, Sel. CR3
     596/    EAFC : B6 EC 01                            LDAA    PIAREGB  ; changed   ;+4  but DEX is gone (-4) so it is a wash     
     597/    EAFF : 85 10                               BITA    #$10     ; changed   ;+2                   ; Check Writeprot?
     598/    EB01 : 26 97                               BNE     SERR2    ;changed    ;+4 ; EB00: 26 93     ; If high set Error (otherwise it conflicts with format.sy)
     599/    EB03 : 84 60                               ANDA    #$60     ; changed   ;+2                   ; Clear all but Bit 5,6 (DS2, DS3)
     600/    EB05 : 16                                  TAB                          ;+2
 AS V1.42 Beta [Bld 216] - Source File floppy2_commented.asm - Page 11 - 02/21/2026 11:24:45 PM


     601/    EB06 : 8A 02                               ORAA    #$02     ; changed   ;+2                   ; Set Bit 1 (WG high)
     602/    EB08 : B7 EC 01                            STAA    PIAREGB  ;write PIAREGB ;+5 ; EAF8: B7 EC 01  
     603/    EB0B :                                                     ; +6 cycles slower
     604/    EB0B : 96 19                               LDAA    CLKFREQ              ;+3 ; EB02: 96 19     ; Waitloop A is 3 on 1MHz
     605/    EB0D : 80 03                               SUBA    #$03                 ;+2 ; EB04: 80 03     ; |
     606/    EB0F : 48                                  ASLA                         ;+2 ; EB06: 48        ; |
     607/    EB10 : 4A                  IEB07           DECA                         ;+2 ; EB07: 4A        ; |
     608/    EB11 : 2A FD                               BPL     IEB07                ;+4 ; EB08: 2A FD     ; | A is FF
     609/    EB13 : F7 EC 01                            STAB    PIAREGB  ;changed   ;+5                    ; Bit 5,6 (DS2, DS3 unaffected), WG low
     610/    EB16 : D6 0E                               LDAB    FUNCSAV             ;+3
     611/    EB18 : 56                                  RORB                        ;+2  ; EB0D: 56        ; ROR FUNCSAV (check Bit 0)
     612/    EB19 : 24 01                               BCC     IEB11               ;+4  ; EB0E: 24 01     ; useless or timing? 
     613/    EB1B :                     ;                BITA    #$56                     ; EB10: 85 56     ; A is now $56, doesn't effect carry
     614/    EB1B : 85                                  FCB     $85                
     615/    EB1C : 56                  IEB11           RORB                             ; EB11: 56        ; ROR FUNCSAV (check Bit 1) set carry
     616/    EB1D :                                                      ; 8 cycles slower
     617/    EB1D : CE 00 05                            LDX     #$0005                   ; EB12: CE 00 05  ; 
     618/    EB20 : BD E9 52                            JSR     WAIT3                    ; EB15: BD E9 53  ; destroys B
     619/    EB23 : C6 40                               LDAB    #$40                     ; EB18: C6 40     ; $40 words
     620/    EB25 : 96 14                               LDAA    ADDRMRK                  ; EB1A: 96 14     ; 
     621/    EB27 : CE 83 F5                            LDX     #$83F5                   ; EB1C: CE 83 F5  ; 
     622/    EB2A : FF EC 04                            STX     SSDA_0                   ; EB1F: FF EC 04  ; 
     623/    EB2D : DE 06                               LDX     CURADRH                  ; EB22: DE 06     ; 
     624/    EB2F : B7 EC 05                            STAA    SSDA_1                   ; EB24: B7 EC 05  ; 
     625/    EB32 : 7E EB 3C                            JMP     WRITSEC              ;3  ; EB27: 7E EB 31  ; 
     626/    EB35 :                     
     627/    EB35 : 86 40               IEB2A           LDAA    #$40                     ; EB2A: 86 40     ; 
     628/    EB37 : B5 EC 04            IEB2C           BITA    SSDA_0                   ; EB2C: B5 EC 04  ; Transmit Datareg. empty?
     629/    EB3A : 27 FB                               BEQ     IEB2C                    ; EB2F: 27 FB     ; If no, wait
     630/    EB3C : 96 12               WRITSEC         LDAA    M0012    ;changed     ;+2                  ; $12 is alway zero    
     631/    EB3E : A6 00                               LDAA    ,X                       ; EB35: A6 00     ; Load Data from RAM
     632/    EB40 : B7 EC 05                            STAA    SSDA_1                   ; EB37: B7 EC 05  ; Write to disk
     633/    EB43 : A6 01                               LDAA    $01,X                    ; EB3A: A6 01     ; Load next Byte
     634/    EB45 : B7 EC 05                            STAA    SSDA_1                   ; EB3C: B7 EC 05  ; Write to disk
     635/    EB48 : 25 02                               BCS     IEB43                    ; EB3F: 25 02     ; if carry is set, don't INX (RWTEST or WRTEST or WRDAM)
     636/    EB4A : 08                                  INX                              ; EB41: 08        ; if not, increase pointer
     637/    EB4B : 08                                  INX                              ; EB42: 08        ; |
     638/    EB4C : 5A                  IEB43           DECB                             ; EB43: 5A        ; decrease counter
     639/    EB4D : 26 E6                               BNE     IEB2A                    ; EB44: 26 E4     ; check if underflow, if not, continue from top
     640/    EB4F : DF 06                               STX     CURADRH                  ; EB46: DF 06     ; done, store current address
     641/    EB51 : CE EC 00                            LDX     #PIAREGA                 ; EB48: CE EC 00  ; 
     642/    EB54 : 86 40                               LDAA    #$40                     ; EB4B: 86 40     ;  
     643/    EB56 : A5 04               IEB4D           BITA    $04,X                    ; EB4D: A5 04     ; Check SSDA Status Reg.
     644/    EB58 : 27 FC                               BEQ     IEB4D                    ; EB4F: 27 FC     ; Wait for Data
     645/    EB5A : E7 05                               STAB    $05,X                    ; EB51: E7 05     ; Store B to Data Register
     646/    EB5C : F6 EC 01                            LDAB    PIAREGB ;read PIAREGB ;+4  ; EB59: E7 01   ;
     647/    EB5F : C4 60                               ANDB    #$60                                       ; Clear all but Side and DS2
     648/    EB61 : CA 08                               ORAB    #$08                ;+2                    ; Set SHIFT_CRC
     649/    EB63 : A5 04               IEB53           BITA    $04,X                    ; EB53: A5 04     ; Check SSDA Status Reg.
     650/    EB65 : 27 FC                               BEQ     IEB53                    ; EB55: 27 FC     ; Wait for Data
     651/    EB67 : F7 EC 01                            STAB    PIAREGB             ;+5
     652/    EB6A : C6 08                               LDAB    #$08                     ; EB57: C6 08     ; |
     653/    EB6C : E7 05                               STAB    $05,X                    ; EB5B: E7 05     ; Store $8 to SSDA Data Reg.
     654/    EB6E : A5 04               IEB5D           BITA    $04,X                    ; EB5D: A5 04     ; Check SSDA Status Reg.
     655/    EB70 : 27 FC                               BEQ     IEB5D                    ; EB5F: 27 FC     ; Wait for Data
     656/    EB72 : C6 FF                               LDAB    #$FF                     ; EB61: C6 FF     ; |
     657/    EB74 : E7 05                               STAB    $05,X                    ; EB63: E7 05     ; |
     658/    EB76 : E7 05                               STAB    $05,X                    ; EB65: E7 05     ; Store $FF to SSDA Data Reg.
     659/    EB78 : F6 EC 01                            LDAB    PIAREGB ;read PIAREGB ;+4 
     660/    EB7B : A5 04               IEB67           BITA    $04,X                    ; EB67: A5 04     ; Check SSDA Status Reg.
 AS V1.42 Beta [Bld 216] - Source File floppy2_commented.asm - Page 12 - 02/21/2026 11:24:45 PM


     661/    EB7D : 27 FC                               BEQ     IEB67                    ; EB69: 27 FC     ; Wait for Data
     662/    EB7F : C4 60                               ANDB    #$60     ; changed ;+2                     ; 
     663/    EB81 : F7 EC 01                            STAB    PIAREGB            ;+5                     ; Clear all but Side and DS2
     664/    EB84 : 7C EC 01                            INC     PIAREGB            ;+6                     ; Set PB0 high
     665/    EB87 : 7C EC 01                            INC     PIAREGB            ;+6                     ; Set PB0 low (toggle RESET), Set WG high
     666/    EB8A : 7E E9 E3                            JMP     NXTSEC    ; -->          ; EB71: 7E E9 D3  ; next sector  
     667/    EB8D :                     
     668/    EB8D :                     ; ###########  about 6 Bytes free
     669/    EB90 :                                     ORG     $EB90
     670/    EB90 :                     
     671/    EB90 : CE 00 14            CLRTOP          LDX     #$0014                   ; EB90: CE 00 14 ; Diagnostic with clear
     672/    EB93 : 6F 5F               ZEB93           CLR     $5F,X                    ; EB93: 6F 5F    ; Clear $60-$73
     673/    EB95 : 09                                  DEX                              ; EB95: 09       ; |
     674/    EB96 : 26 FB                               BNE     ZEB93                    ; EB96: 26 FB    ; |
     675/    EB98 : 7E ED 92            TOP             JMP     TOPEXT                                    ; Jump to external ROM
     676/    EB9B :                     
     677/    EB9B : CE D0 D8            READINIT        LDX     #$D0D8                   ; E9AC: CE D0 D8  ; Select CR2 and Inhibit SM, 2-Byte RDA, 8-Bit Word
     678/    EB9E : FF EC 04                            STX     SSDA_0                   ; E9AF: FF EC 04  ; |
     679/    EBA1 : CE EC 00                            LDX     #PIAREGA                 ; E9B2: CE EC 00  ; 
     680/    EBA4 : 86 50                               LDAA    #$50                     ; E9B5: 86 50     ; 
     681/    EBA6 : A7 04                               STAA    $04,X              ;6    ; E9B7: A7 04     ; Write $50 to SSDA_0 (Enable Read)
     682/    EBA8 : B6 EC 01                            LDAA    PIAREGB            ;+4                     ; Read PIAREGB
     683/    EBAB : 84 60                               ANDA    #$60               ;+2                     ; clear all but Bit 5,6
     684/    EBAD : 8A 07                               ORAA    #$07               ;+2                     ; same as before but leave PB5,6
     685/    EBAF : A7 01                               STAA    $01,X   ;write PIAREGB ;6 ; E9BB: A7 01    ; Set Bit0,1,2 in PIAREGB (Set to Read, Reset active., WG inact.)
     686/    EBB1 : 6A 01                               DEC     $01,X   ;write PIAREGB ;7  ; E9BD: 6A 01   ; Reset inact.
     687/    EBB3 : 4A                                  DECA                      ;+2                    ; timing
     688/    EBB4 :                                     ;INX                        ;+4 didnt help
     689/    EBB4 :                                     ;DEX                        ;+4 didnt help
     690/    EBB4 : 86 40                               LDAA    #$40                     ; E9C1: 86 40     ; Write $40 to SSDA_0 (Enable Sync, Select CR2)
     691/    EBB6 : A7 04                               STAA    $04,X                    ; E9C3: A7 04     ; 
     692/    EBB8 : 86 98                               LDAA    #$98                     ; E9C5: 86 98     ; Write $98 to SSDA_1 (Enable SM Output)
     693/    EBBA : A7 05                               STAA    $05,X                    ; E9C7: A7 05     ; 
     694/    EBBC : 39                                  RTS                              ; E9C9: 39        ; 
     695/    EBBD :                     
     696/    EBBD :                     ;------------------------------------------------
     697/    EBBD :                     ; ########### 3 Bytes free
     698/    EBC0 :                                     ORG     $EBC0
     699/    EBC0 : 7E ED B6            LPINIT          JMP     LPINITEXT
     700/    EBC3 :                     ;------------------------------------------------
     701/    EBC3 :                     ; ########### 9 Bytes free
     702/    EBCC :                                     ORG     $EBCC
     703/    EBCC : 7E ED C2            LIST            JMP     LPLISTEXT
     704/    EBCF :                     ;------------------------------------------------
     705/    EBCF : 86 FE               FDINITEXT       LDAA    #$FE                ; | $ FE00-03  is a pointer to the Position of Track / Drive
     706/    EBD1 : B7 FE 04                            STAA    $FE04               ; | $FE04 <- $FE 
     707/    EBD4 : CE 00 00                            LDX     #$0000
     708/    EBD7 : 7F 00 12                            CLR     $12
     709/    EBDA : 7E E8 25                            JMP     FDINTBACK
     710/    EBDD :                     ;------------------------------------------------
     711/    EBDD :                     ; ########### 7 Bytes free
     712/    EBE4 :                                     ORG     $EBE4
     713/    EBE4 : 7E ED DA            LDATA           JMP     LPDATEXT 
     714/    EBE7 :                     ;------------------------------------------------
     715/    EBE7 : BD E8 22            FDINIT3         JSR     FDINIT              ; EBA6: BD E8 22  ; 
     716/    EBEA : 7E E8 87                            JMP     CLOCK               ; EBA9: 7E E8 87  ; initializes and starts drive, then jumps to CLKDMD
     717/    EBED :                     ;------------------------------------------------
     718/    EBED :                     ; ########### 5 Bytes free
     719/    EBF2 :                                     ORG     $EBF2
     720/    EBF2 : 7E ED E8            LDATA1          JMP     LPDAT0EXT
 AS V1.42 Beta [Bld 216] - Source File floppy2_commented.asm - Page 13 - 02/21/2026 11:24:45 PM


     721/    EBF5 :                     ;------------------------------------------------
     722/    EBFE :                                     ORG     $EBFE
     723/    EBFE : 07 50                               FDB     $0750                    ; EBFE: 07 50          '.P'
     724/    EC00 :                     
     725/    EC00 :                                     REPT    $100                      ; Filler for IO Area
     726/    EC00 :                                     FCB     $10
     727/    EC00 :                                     ENDM
     726/    EC00 : 10                                  FCB     $10
     726/    EC01 : 10                                  FCB     $10
     726/    EC02 : 10                                  FCB     $10
     726/    EC03 : 10                                  FCB     $10
     726/    EC04 : 10                                  FCB     $10
     726/    EC05 : 10                                  FCB     $10
     726/    EC06 : 10                                  FCB     $10
     726/    EC07 : 10                                  FCB     $10
     726/    EC08 : 10                                  FCB     $10
     726/    EC09 : 10                                  FCB     $10
     726/    EC0A : 10                                  FCB     $10
     726/    EC0B : 10                                  FCB     $10
     726/    EC0C : 10                                  FCB     $10
     726/    EC0D : 10                                  FCB     $10
     726/    EC0E : 10                                  FCB     $10
     726/    EC0F : 10                                  FCB     $10
     726/    EC10 : 10                                  FCB     $10
     726/    EC11 : 10                                  FCB     $10
     726/    EC12 : 10                                  FCB     $10
     726/    EC13 : 10                                  FCB     $10
     726/    EC14 : 10                                  FCB     $10
     726/    EC15 : 10                                  FCB     $10
     726/    EC16 : 10                                  FCB     $10
     726/    EC17 : 10                                  FCB     $10
     726/    EC18 : 10                                  FCB     $10
     726/    EC19 : 10                                  FCB     $10
     726/    EC1A : 10                                  FCB     $10
     726/    EC1B : 10                                  FCB     $10
     726/    EC1C : 10                                  FCB     $10
     726/    EC1D : 10                                  FCB     $10
     726/    EC1E : 10                                  FCB     $10
     726/    EC1F : 10                                  FCB     $10
     726/    EC20 : 10                                  FCB     $10
     726/    EC21 : 10                                  FCB     $10
     726/    EC22 : 10                                  FCB     $10
     726/    EC23 : 10                                  FCB     $10
     726/    EC24 : 10                                  FCB     $10
     726/    EC25 : 10                                  FCB     $10
     726/    EC26 : 10                                  FCB     $10
     726/    EC27 : 10                                  FCB     $10
     726/    EC28 : 10                                  FCB     $10
     726/    EC29 : 10                                  FCB     $10
     726/    EC2A : 10                                  FCB     $10
     726/    EC2B : 10                                  FCB     $10
     726/    EC2C : 10                                  FCB     $10
     726/    EC2D : 10                                  FCB     $10
     726/    EC2E : 10                                  FCB     $10
     726/    EC2F : 10                                  FCB     $10
     726/    EC30 : 10                                  FCB     $10
     726/    EC31 : 10                                  FCB     $10
     726/    EC32 : 10                                  FCB     $10
     726/    EC33 : 10                                  FCB     $10
     726/    EC34 : 10                                  FCB     $10
 AS V1.42 Beta [Bld 216] - Source File floppy2_commented.asm - Page 14 - 02/21/2026 11:24:45 PM


     726/    EC35 : 10                                  FCB     $10
     726/    EC36 : 10                                  FCB     $10
     726/    EC37 : 10                                  FCB     $10
     726/    EC38 : 10                                  FCB     $10
     726/    EC39 : 10                                  FCB     $10
     726/    EC3A : 10                                  FCB     $10
     726/    EC3B : 10                                  FCB     $10
     726/    EC3C : 10                                  FCB     $10
     726/    EC3D : 10                                  FCB     $10
     726/    EC3E : 10                                  FCB     $10
     726/    EC3F : 10                                  FCB     $10
     726/    EC40 : 10                                  FCB     $10
     726/    EC41 : 10                                  FCB     $10
     726/    EC42 : 10                                  FCB     $10
     726/    EC43 : 10                                  FCB     $10
     726/    EC44 : 10                                  FCB     $10
     726/    EC45 : 10                                  FCB     $10
     726/    EC46 : 10                                  FCB     $10
     726/    EC47 : 10                                  FCB     $10
     726/    EC48 : 10                                  FCB     $10
     726/    EC49 : 10                                  FCB     $10
     726/    EC4A : 10                                  FCB     $10
     726/    EC4B : 10                                  FCB     $10
     726/    EC4C : 10                                  FCB     $10
     726/    EC4D : 10                                  FCB     $10
     726/    EC4E : 10                                  FCB     $10
     726/    EC4F : 10                                  FCB     $10
     726/    EC50 : 10                                  FCB     $10
     726/    EC51 : 10                                  FCB     $10
     726/    EC52 : 10                                  FCB     $10
     726/    EC53 : 10                                  FCB     $10
     726/    EC54 : 10                                  FCB     $10
     726/    EC55 : 10                                  FCB     $10
     726/    EC56 : 10                                  FCB     $10
     726/    EC57 : 10                                  FCB     $10
     726/    EC58 : 10                                  FCB     $10
     726/    EC59 : 10                                  FCB     $10
     726/    EC5A : 10                                  FCB     $10
     726/    EC5B : 10                                  FCB     $10
     726/    EC5C : 10                                  FCB     $10
     726/    EC5D : 10                                  FCB     $10
     726/    EC5E : 10                                  FCB     $10
     726/    EC5F : 10                                  FCB     $10
     726/    EC60 : 10                                  FCB     $10
     726/    EC61 : 10                                  FCB     $10
     726/    EC62 : 10                                  FCB     $10
     726/    EC63 : 10                                  FCB     $10
     726/    EC64 : 10                                  FCB     $10
     726/    EC65 : 10                                  FCB     $10
     726/    EC66 : 10                                  FCB     $10
     726/    EC67 : 10                                  FCB     $10
     726/    EC68 : 10                                  FCB     $10
     726/    EC69 : 10                                  FCB     $10
     726/    EC6A : 10                                  FCB     $10
     726/    EC6B : 10                                  FCB     $10
     726/    EC6C : 10                                  FCB     $10
     726/    EC6D : 10                                  FCB     $10
     726/    EC6E : 10                                  FCB     $10
     726/    EC6F : 10                                  FCB     $10
     726/    EC70 : 10                                  FCB     $10
 AS V1.42 Beta [Bld 216] - Source File floppy2_commented.asm - Page 15 - 02/21/2026 11:24:45 PM


     726/    EC71 : 10                                  FCB     $10
     726/    EC72 : 10                                  FCB     $10
     726/    EC73 : 10                                  FCB     $10
     726/    EC74 : 10                                  FCB     $10
     726/    EC75 : 10                                  FCB     $10
     726/    EC76 : 10                                  FCB     $10
     726/    EC77 : 10                                  FCB     $10
     726/    EC78 : 10                                  FCB     $10
     726/    EC79 : 10                                  FCB     $10
     726/    EC7A : 10                                  FCB     $10
     726/    EC7B : 10                                  FCB     $10
     726/    EC7C : 10                                  FCB     $10
     726/    EC7D : 10                                  FCB     $10
     726/    EC7E : 10                                  FCB     $10
     726/    EC7F : 10                                  FCB     $10
     726/    EC80 : 10                                  FCB     $10
     726/    EC81 : 10                                  FCB     $10
     726/    EC82 : 10                                  FCB     $10
     726/    EC83 : 10                                  FCB     $10
     726/    EC84 : 10                                  FCB     $10
     726/    EC85 : 10                                  FCB     $10
     726/    EC86 : 10                                  FCB     $10
     726/    EC87 : 10                                  FCB     $10
     726/    EC88 : 10                                  FCB     $10
     726/    EC89 : 10                                  FCB     $10
     726/    EC8A : 10                                  FCB     $10
     726/    EC8B : 10                                  FCB     $10
     726/    EC8C : 10                                  FCB     $10
     726/    EC8D : 10                                  FCB     $10
     726/    EC8E : 10                                  FCB     $10
     726/    EC8F : 10                                  FCB     $10
     726/    EC90 : 10                                  FCB     $10
     726/    EC91 : 10                                  FCB     $10
     726/    EC92 : 10                                  FCB     $10
     726/    EC93 : 10                                  FCB     $10
     726/    EC94 : 10                                  FCB     $10
     726/    EC95 : 10                                  FCB     $10
     726/    EC96 : 10                                  FCB     $10
     726/    EC97 : 10                                  FCB     $10
     726/    EC98 : 10                                  FCB     $10
     726/    EC99 : 10                                  FCB     $10
     726/    EC9A : 10                                  FCB     $10
     726/    EC9B : 10                                  FCB     $10
     726/    EC9C : 10                                  FCB     $10
     726/    EC9D : 10                                  FCB     $10
     726/    EC9E : 10                                  FCB     $10
     726/    EC9F : 10                                  FCB     $10
     726/    ECA0 : 10                                  FCB     $10
     726/    ECA1 : 10                                  FCB     $10
     726/    ECA2 : 10                                  FCB     $10
     726/    ECA3 : 10                                  FCB     $10
     726/    ECA4 : 10                                  FCB     $10
     726/    ECA5 : 10                                  FCB     $10
     726/    ECA6 : 10                                  FCB     $10
     726/    ECA7 : 10                                  FCB     $10
     726/    ECA8 : 10                                  FCB     $10
     726/    ECA9 : 10                                  FCB     $10
     726/    ECAA : 10                                  FCB     $10
     726/    ECAB : 10                                  FCB     $10
     726/    ECAC : 10                                  FCB     $10
 AS V1.42 Beta [Bld 216] - Source File floppy2_commented.asm - Page 16 - 02/21/2026 11:24:45 PM


     726/    ECAD : 10                                  FCB     $10
     726/    ECAE : 10                                  FCB     $10
     726/    ECAF : 10                                  FCB     $10
     726/    ECB0 : 10                                  FCB     $10
     726/    ECB1 : 10                                  FCB     $10
     726/    ECB2 : 10                                  FCB     $10
     726/    ECB3 : 10                                  FCB     $10
     726/    ECB4 : 10                                  FCB     $10
     726/    ECB5 : 10                                  FCB     $10
     726/    ECB6 : 10                                  FCB     $10
     726/    ECB7 : 10                                  FCB     $10
     726/    ECB8 : 10                                  FCB     $10
     726/    ECB9 : 10                                  FCB     $10
     726/    ECBA : 10                                  FCB     $10
     726/    ECBB : 10                                  FCB     $10
     726/    ECBC : 10                                  FCB     $10
     726/    ECBD : 10                                  FCB     $10
     726/    ECBE : 10                                  FCB     $10
     726/    ECBF : 10                                  FCB     $10
     726/    ECC0 : 10                                  FCB     $10
     726/    ECC1 : 10                                  FCB     $10
     726/    ECC2 : 10                                  FCB     $10
     726/    ECC3 : 10                                  FCB     $10
     726/    ECC4 : 10                                  FCB     $10
     726/    ECC5 : 10                                  FCB     $10
     726/    ECC6 : 10                                  FCB     $10
     726/    ECC7 : 10                                  FCB     $10
     726/    ECC8 : 10                                  FCB     $10
     726/    ECC9 : 10                                  FCB     $10
     726/    ECCA : 10                                  FCB     $10
     726/    ECCB : 10                                  FCB     $10
     726/    ECCC : 10                                  FCB     $10
     726/    ECCD : 10                                  FCB     $10
     726/    ECCE : 10                                  FCB     $10
     726/    ECCF : 10                                  FCB     $10
     726/    ECD0 : 10                                  FCB     $10
     726/    ECD1 : 10                                  FCB     $10
     726/    ECD2 : 10                                  FCB     $10
     726/    ECD3 : 10                                  FCB     $10
     726/    ECD4 : 10                                  FCB     $10
     726/    ECD5 : 10                                  FCB     $10
     726/    ECD6 : 10                                  FCB     $10
     726/    ECD7 : 10                                  FCB     $10
     726/    ECD8 : 10                                  FCB     $10
     726/    ECD9 : 10                                  FCB     $10
     726/    ECDA : 10                                  FCB     $10
     726/    ECDB : 10                                  FCB     $10
     726/    ECDC : 10                                  FCB     $10
     726/    ECDD : 10                                  FCB     $10
     726/    ECDE : 10                                  FCB     $10
     726/    ECDF : 10                                  FCB     $10
     726/    ECE0 : 10                                  FCB     $10
     726/    ECE1 : 10                                  FCB     $10
     726/    ECE2 : 10                                  FCB     $10
     726/    ECE3 : 10                                  FCB     $10
     726/    ECE4 : 10                                  FCB     $10
     726/    ECE5 : 10                                  FCB     $10
     726/    ECE6 : 10                                  FCB     $10
     726/    ECE7 : 10                                  FCB     $10
     726/    ECE8 : 10                                  FCB     $10
 AS V1.42 Beta [Bld 216] - Source File floppy2_commented.asm - Page 17 - 02/21/2026 11:24:45 PM


     726/    ECE9 : 10                                  FCB     $10
     726/    ECEA : 10                                  FCB     $10
     726/    ECEB : 10                                  FCB     $10
     726/    ECEC : 10                                  FCB     $10
     726/    ECED : 10                                  FCB     $10
     726/    ECEE : 10                                  FCB     $10
     726/    ECEF : 10                                  FCB     $10
     726/    ECF0 : 10                                  FCB     $10
     726/    ECF1 : 10                                  FCB     $10
     726/    ECF2 : 10                                  FCB     $10
     726/    ECF3 : 10                                  FCB     $10
     726/    ECF4 : 10                                  FCB     $10
     726/    ECF5 : 10                                  FCB     $10
     726/    ECF6 : 10                                  FCB     $10
     726/    ECF7 : 10                                  FCB     $10
     726/    ECF8 : 10                                  FCB     $10
     726/    ECF9 : 10                                  FCB     $10
     726/    ECFA : 10                                  FCB     $10
     726/    ECFB : 10                                  FCB     $10
     726/    ECFC : 10                                  FCB     $10
     726/    ECFD : 10                                  FCB     $10
     726/    ECFE : 10                                  FCB     $10
     726/    ECFF : 10                                  FCB     $10
     728/    ED00 :                                     
     729/    ED00 :                     
     730/    ED00 :                     ; ################################################################
     731/    ED00 :                     ; Extended ROM
     732/    ED00 :                     ; ################################################################
     733/    ED00 :                                       ORG $ED00
     734/    ED00 :                     
     735/    ED00 : BD ED 22            CLKDMD          JSR     RETRG                    ; EB85: 8D ED     ; Retrigger NMI Timer
     736/    ED03 : E6 01                               LDAB    $01,X                    ; EB87: E6 01     ; PIAREGB Clear Interrupt Flag
     737/    ED05 : 4F                                  CLRA                             ; EB89: 4F        ;  
     738/    ED06 : E6 03               CONT01          LDAB    $03,X                    ; EB8A: E6 03     ; PIACTRLB
     739/    ED08 : 2A FC                               BPL     CONT01                   ; EB8C: 2A FC     ; Wait for IRQB on CB1 (IDX)
     740/    ED0A : E6 01                               LDAB    $01,X                    ; EB8E: E6 01     ; PIAREGB Clear Interrupt Flag
     741/    ED0C : 5F                  IDXHER          CLRB                             ; EB90: 5F        ;  
     742/    ED0D : 5A                  IEB91           DECB                             ; EB91: 5A        ; Wait
     743/    ED0E : 26 FD                               BNE     IEB91                    ; EB92: 26 FD     ; |
     744/    ED10 : 4C                                  INCA                             ; EB94: 4C        ; In A is the ammount of 256 ticks
     745/    ED11 : 6D 03                               TST     $03,X                    ; EB95: 6D 03     ; PIACTRLB
     746/    ED13 : 2A F7                               BPL     IDXHER                   ; EB97: 2A F7     ; Wait for IRQB on CB1 (IDX) 166ms later
     747/    ED15 : 5C                                  INCB                             ; EB99: 5C        ; B is 1 now
     748/    ED16 : 80 4B                               SUBA    #$4B                     ; EB9A: 80 4B     ;  
     749/    ED18 : 5C                  IEB9C           INCB                             ; EB9C: 5C        ;  
     750/    ED19 : 80 16               CONT02          SUBA    #$16                     ; EB9D: 80 16     ;  
     751/    ED1B : 24 FB                               BCC     IEB9C                    ; EB9F: 24 FB     ;  
     752/    ED1D : D7 19                               STAB    CLKFREQ                  ; EBA1: D7 19     ; B is 3 for 1MHz
     753/    ED1F : 7E E9 90                            JMP     EXITHNDLR  ; -->         ; EBA3: 7E E9 91  ; EXITHNDLR has RTS
     754/    ED22 :                     
     755/    ED22 :                     ;------------------------------------------------
     756/    ED22 :                     ; from here new code
     757/    ED22 :                     ;------------------------------------------------                
     758/    ED22 : CE EC 00            RETRG           LDX     #PIAREGA                 ; EB74: CE EC 00  ; 
     759/    ED25 : 86 36                               LDAA    #$36                     ; EB77: 86 36     ; |
     760/    ED27 : A7 03                               STAA    $03,X                    ; EB79: A7 03     ; $36 -> PIACTRLB (CB2 Low - Trigger NMI Timer, IRQB Flag set by HL on CB1 - IDX, Select Output Reg. B)
     761/    ED29 :                                     ;NOP
     762/    ED29 : 86 3E                               LDAA    #$3E                     ; EB7B: 86 3E     ; |
     763/    ED2B : A7 03                               STAA    $03,X                    ; EB7D: A7 03     ; $3E -> PIACTRLB (CB2 high)
     764/    ED2D : E6 00                               LDAB    ,X                       ; EB7F: E6 00     ; Get Port A
 AS V1.42 Beta [Bld 216] - Source File floppy2_commented.asm - Page 18 - 02/21/2026 11:24:45 PM


     765/    ED2F : 4A                                  DECA                             ; EB81: 4A        ; 
     766/    ED30 : A7 02                               STAA    $02,X                    ; EB82: A7 02     ; $3D -> PIACTRLA (En. IRQA interrupt by CA1 - NMI Timer, Sel. Output Reg. A, CA2 high - STEP)
     767/    ED32 : 39                                  RTS                              ; EB84: 39        ; 
     768/    ED33 :                     ;------------------------------------------------
     769/    ED33 :                     ; NMI ISR, fires when Timeout
     770/    ED33 :                     ;------------------------------------------------
     771/    ED33 : 9E 16               NMIISR          LDS     STACKSAV                 ; E939: 9E 16     ; 
     772/    ED35 : C6 35                               LDAB    #$35                     ; E93B: C6 35     ; Set Error '5' (TIMEOUT)
     773/    ED37 :                     ;                CPX     #MC637                   ; E93D: 8C C6 37  ; 
     774/    ED37 : 8C                                  FCB     $8C
     775/    ED38 : C6 37               xSERR7          LDAB    #$37                                       ; Set Error '7' (SEEK ERROR)
     776/    ED3A : D7 08               SETERR         STAB    FDSTAT                   ; E940: D7 08     ; 
     777/    ED3C : BD E9 90                            JSR     EXITHNDLR                ; E942: 8D 4D     ; 
     778/    ED3F : 0D                                  SEC                              ; E944: 0D        ; 
     779/    ED40 : 39                                  RTS                              ; E945: 39        ; 
     780/    ED41 :                     ;------------------------------------------------
     781/    ED41 :                     ; Calculate Tracks and Sectors of Sectors only Input
     782/    ED41 :                     ; Returns A as wanted Track
     783/    ED41 :                     ; Modifies SofTRK, SECTCNT
     784/    ED41 :                     ;------------------------------------------------
     785/    ED41 : 86 FF               CALCTRK         LDAA    #$FF     ; 
     786/    ED43 : 97 0A                               STAA    SofTRK   ; 
     787/    ED45 : 96 10                               LDAA    EXDSKSD  ;  Bit 7 high == SS
     788/    ED47 : 2A 25                               BPL     DUALSIDE ; 
     789/    ED49 : 96 01                               LDAA    STRSCTH  ; $0
     790/    ED4B : D6 02                               LDAB    STRSCTL  ; $D0
     791/    ED4D : 7C 00 0A            SE8EA           INC     SofTRK   ; is now at 0, increase to 1
     792/    ED50 : C0 D0                               SUBB    #$D0     ; 0xd0 = 8 tracks exactly
     793/    ED52 : 82 00                               SBCA    #$00     ; 
     794/    ED54 : 24 F7                               BCC     SE8EA    ; carry is clear, carry is set now
     795/    ED56 : CB D0                               ADDB    #$D0     ; D contains $0
     796/    ED58 : 96 0A                               LDAA    SofTRK   ; is 1
     797/    ED5A : 48                                  ASLA             ; 2
     798/    ED5B : 48                                  ASLA             ; 4
     799/    ED5C : 48                                  ASLA             ; SofTRK * 8
     800/    ED5D : 4A                                  DECA             ; 7
     801/    ED5E : 4C                  SE8FB           INCA             ; 8
     802/    ED5F : C0 1A                               SUBB    #$1A     ; B is 0
     803/    ED61 : 24 FB                               BCC     SE8FB    ; carry is set
     804/    ED63 : CB 1A                               ADDB    #$1A     ; B is 0 again
     805/    ED65 : D7 0A                               STAB    SofTRK   ; A is 8, SofTRK = 0
     806/    ED67 : DE 03                               LDX     NUMSCTH  ; A is Track wanted!
     807/    ED69 : DF 0B                               STX     SECTCNT  ; 
     808/    ED6B : D6 13                               LDAB    TRACKSAV ; 
     809/    ED6D : 39                                  RTS              ; 
     810/    ED6E :                     ;------------------------------------------------
     811/    ED6E : 96 01               DUALSIDE        LDAA    STRSCTH  ; $0
     812/    ED70 : D6 02                               LDAB    STRSCTL  ; $D0
     813/    ED72 : 7C 00 0A            DE8EA           INC     SofTRK   ; is now 0, increase to 1
     814/    ED75 : C0 D0                               SUBB    #$D0     ; $D0 is exactly 4 Tracks
     815/    ED77 : 82 00                               SBCA    #$00     ; 
     816/    ED79 :                                     ;SUBB    #$A0     ; $D0 is exactly 4 Tracks
     817/    ED79 :                                     ;SBCA    #$01     ; 
     818/    ED79 : 24 F7                               BCC     DE8EA    ; carry is clear, carry is set now
     819/    ED7B : CB D0                               ADDB    #$D0     ; D contains $0
     820/    ED7D :                                     ;ADDB    #$A0     ; D contains $0
     821/    ED7D :                                     ;ADDA    #$01
     822/    ED7D : 96 0A                               LDAA    SofTRK   ; is 1
     823/    ED7F : 48                                  ASLA             ; 2
     824/    ED80 : 48                                  ASLA             ; 4
 AS V1.42 Beta [Bld 216] - Source File floppy2_commented.asm - Page 19 - 02/21/2026 11:24:45 PM


     825/    ED81 :                                     ;ASLA             ; 8
     826/    ED81 : 4A                                  DECA             ; 7
     827/    ED82 : 4C                  DE8FB           INCA             ; 8
     828/    ED83 : C0 34                               SUBB    #$34     ; B is 0
     829/    ED85 : 24 FB                               BCC     DE8FB    ; carry is set
     830/    ED87 : CB 34                               ADDB    #$34     ; b is 0 again
     831/    ED89 : D7 0A                               STAB    SofTRK   ; A = 4, SofTRK = 0
     832/    ED8B :                                     ;SUBB    #27      ; is it side 1?
     833/    ED8B :                                     ;BCS     SIDE0
     834/    ED8B :                                     ;LDAB    PIAREGB                  ; 
     835/    ED8B :                                     ;ANDB    #$BF                     ; Reset Side (= Side 1)
     836/    ED8B :                                     ;STAB    PIAREGB                  ;                 
     837/    ED8B : DE 03               SIDE0           LDX     NUMSCTH  ; A is Track wanted!
     838/    ED8D : DF 0B                               STX     SECTCNT  ; 
     839/    ED8F : D6 13                               LDAB    TRACKSAV ; 
     840/    ED91 : 39                                  RTS              ; 
     841/    ED92 :                     
     842/    ED92 :                     ;ED00     jmp WRITINI
     843/    ED92 :                     ;ED03    jmp TOP
     844/    ED92 :                     ;ED06    jmp LPINIT
     845/    ED92 :                     ;ED09    jmp LIST
     846/    ED92 :                     ;ED0C    jmp LDATA
     847/    ED92 :                     ;ED0F    jmp LDATA1
     848/    ED92 :                     ;ED12    jmp EXIT
     849/    ED92 :                     ;ED15    jmp EXIT
     850/    ED92 :                     ;ED18    jmp EXIT
     851/    ED92 :                     ;EXIT    rts
     852/    ED92 :                     
     853/    ED92 :                     ;------------------------------------------------
     854/    ED92 :                     ; Disk Mini Diagnostic Routine (CLRTOP is in original ROM)
     855/    ED92 :                     ;------------------------------------------------
     856/    ED92 : BD E8 22            TOPEXT          JSR     FDINIT                   ; EB98: BD E8 22 ; Diagnostic without clear
     857/    ED95 : BD E8 75                            JSR     RESTOR                   ; EB9B: BD E8 75 ; 
     858/    ED98 : DE 20               ZEB9E           LDX     LDADDR                   ; EB9E: DE 20    ; 
     859/    ED9A : DF 06                               STX     CURADRH                  ; EBA0: DF 06    ; 
     860/    ED9C : DE 22                               LDX     EXADDR                   ; EBA2: DE 22    ; must contain addres of function (READSC,...)
     861/    ED9E : AD 00                               JSR     ,X                       ; EBA4: AD 00    ; 
     862/    EDA0 : 96 24                               LDAA    ONECON                   ; EBA6: 96 24    ; 
     863/    EDA2 : 26 0F                               BNE     ZEBB9                    ; EBA8: 26 0F    ; 
     864/    EDA4 : 97 07                               STAA    CURADRL                  ; EBAA: 97 07    ; 
     865/    EDA6 : 78 00 08                            ASL     FDSTAT                   ; EBAC: 78 00 08 ; 
     866/    EDA9 : DE 07                               LDX     CURADRL                  ; EBAF: DE 07    ; 
     867/    EDAB : 6C 01                               INC     $01,X                    ; EBB1: 6C 01    ; 
     868/    EDAD : 26 E9                               BNE     ZEB9E                    ; EBB3: 26 E9    ; 
     869/    EDAF : 6C 00                               INC     ,X                       ; EBB5: 6C 00    ; 
     870/    EDB1 : 26 E5                               BNE     ZEB9E                    ; EBB7: 26 E5    ; 
     871/    EDB3 : 7E E8 55            ZEBB9           JMP     PRNTE2                   ; EBB9: 7E E8 55 ; Print Error Code
     872/    EDB6 :                     
     873/    EDB6 :                     ;------------------------------------------------
     874/    EDB6 :                     ; Line Printer Routines
     875/    EDB6 :                     ;------------------------------------------------
     876/    EDB6 : CE FF 2E            LPINITEXT       LDX     #$FF2E                   ; EBC0: CE FF 2E ; Line Printer Init
     877/    EDB9 : FF EC 10                            STX     LPTPIA0                  ; EBC3: FF EC 10 ; <------- PIA here ?
     878/    EDBC : 86 3C                               LDAA    #$3C                     ; EBC6: 86 3C    ; 
     879/    EDBE : B7 EC 13                            STAA    LPTPIA3                  ; EBC8: B7 EC 13 ; <------- PIA here ?
     880/    EDC1 : 39                                  RTS                              ; EBCB: 39       ; 
     881/    EDC2 :                     ;------------------------------------------------
     882/    EDC2 : B7 EC 10            LPLISTEXT       STAA    LPTPIA0                  ; EBCC: B7 EC 10 ; Print contents of A
     883/    EDC5 : B6 EC 10                            LDAA    LPTPIA0                  ; EBCF: B6 EC 10 ; <------- PIA here ?
     884/    EDC8 : 37                  ZEBD2           PSHB                             ; EBD2: 37       ; 
 AS V1.42 Beta [Bld 216] - Source File floppy2_commented.asm - Page 20 - 02/21/2026 11:24:45 PM


     885/    EDC9 : F6 EC 12                            LDAB    LPTPIA2                  ; EBD3: F6 EC 12 ; <------- PIA here ?
     886/    EDCC : C4 03                               ANDB    #$03                     ; EBD6: C4 03    ; 
     887/    EDCE : 5A                                  DECB                             ; EBD8: 5A       ; 
     888/    EDCF : 33                                  PULB                             ; EBD9: 33       ; 
     889/    EDD0 : 26 06                               BNE     ZEBE2                    ; EBDA: 26 06    ; 
     890/    EDD2 : 7D EC 11                            TST     LPTPIA1                  ; EBDC: 7D EC 11 ; <------- PIA here ?
     891/    EDD5 : 2A F1                               BPL     ZEBD2                    ; EBDF: 2A F1    ; 
     892/    EDD7 : 39                                  RTS                              ; EBE1: 39       ; 
     893/    EDD8 :                     ;------------------------------------------------
     894/    EDD8 : 0D                  ZEBE2           SEC                              ; EBE2: 0D       ; 
     895/    EDD9 : 39                                  RTS                              ; EBE3: 39       ; 
     896/    EDDA :                     ;------------------------------------------------
     897/    EDDA : 86 0D               LPDATEXT        LDAA    #$0D                     ; EBE4: 86 0D    ; Send String to Printer
     898/    EDDC : 8D E4               ZEBE6           BSR     LPLISTEXT                ; EBE6: 8D E4    ; 
     899/    EDDE : 25 FC                               BCS     ZEBE6                    ; EBE8: 25 FC    ; 
     900/    EDE0 : 86 0A                               LDAA    #$0A                     ; EBEA: 86 0A    ; 
     901/    EDE2 : 09                                  DEX                              ; EBEC: 09       ; 
     902/    EDE3 : 8D DD               ZEBED           BSR     LPLISTEXT                ; EBED: 8D DD    ; 
     903/    EDE5 : 25 FC                               BCS     ZEBED                    ; EBEF: 25 FC    ; 
     904/    EDE7 : 08                                  INX                              ; EBF1: 08       ; 
     905/    EDE8 : A6 00               LPDAT0EXT       LDAA    ,X                       ; EBF2: A6 00    ; 
     906/    EDEA : 81 04                               CMPA    #$04                     ; EBF4: 81 04    ; 
     907/    EDEC : 26 F5                               BNE     ZEBED                    ; EBF6: 26 F5    ; 
     908/    EDEE : 39                                  RTS                              ; EBF8: 39       ; 
     909/    EDEF :                     ;------------------------------------------------
     910/    EDEF :                     
     911/    EDEF :                     
     912/    EDEF :                     
     913/    EDEF :                     
     914/    EFFE :                                     ORG     $EFFE          ; Just to make sure the Area from End to EFFF is filled
     915/    EFFE : 07 50                               FDB     $0750
     916/    F000 :                     
 AS V1.42 Beta [Bld 216] - Source File floppy2_commented.asm - Page 21 - 02/21/2026 11:24:45 PM


  Symbol Table (* = unused):
  --------------------------

 ADDRMRK :                       14 - |
*ARCHITECTURE :                                      "x86_64-unknown-linux" - |
*BIGENDIAN :                      0 - | *BRANCHEXT :                      0 - |
 CALCTRK :                     ED41 C | *CASESENSITIVE :                  0 - |
 CHECKAGAIN :                  E8D6 C |  CHKERR :                      E853 C |
 CLKDMD :                      ED00 C |  CLKFREQ :                       19 - |
 CLOCK :                       E887 C |  CLOCKN :                      E908 C |
*CLRTOP :                      EB90 C | *COMPMODE :                       0 - |
*CONSTPI :        3.141592653589793 - |  CONT01 :                      ED06 C |
*CONT02 :                      ED19 C |  CRCOK :                       EAD2 C |
 CRCONLY :                     EAC0 C |  CURADRH :                        6 - |
 CURADRL :                        7 - |  CURDRV :                         0 - |
*CUSTOM :                         0 - |  CWRDCNT :                        9 - |
*DATE :                "02/21/2026" - |  DE8EA :                       ED72 C |
 DE8FB :                       ED82 C |  DRDCNT :                        18 - |
 DRIVETHREE :                  E9A8 C |  DRVRDY :                      E8F8 C |
 DRVZRO :                      E8BA C |  DUALSIDE :                    ED6E C |
 DWRDCNT :                       15 - |  EXADDR :                        22 - |
 EXDSKSD :                       10 - |  EXITHNDLR :                   E990 C |
*FALSE :                          0 - |  FDINIT :                      E822 C |
 FDINIT2 :                     E850 C |  FDINIT3 :                     EBE7 C |
 FDINITEXT :                   EBCF C |  FDINTBACK :                   E825 C |
 FDSTAT :                         8 - | *FULLPMMU :                       1 - |
 FUNCSAV :                        E - | *HAS64 :                          1 - |
*HASDSP :                         0 - | *HASFPU :                         0 - |
*HASPMMU :                        0 - |  IDXHER :                      ED0C C |
 IE917 :                       E928 C | *IE91F :                       E928 C |
 IE961 :                       E960 C |  IE980 :                       E97F C |
 IE9F2 :                       EA02 C | *IEA0C :                       EA12 C |
 IEA1A :                       EA1E C |  IEA1C :                       EA21 C |
 IEA26 :                       EA2B C |  IEA32 :                       EA37 C |
 IEA3E :                       EA43 C |  IEA46 :                       EA4B C |
 IEA52 :                       EA57 C |  IEA64 :                       EA69 C |
 IEA6B :                       EA70 C |  IEA70 :                       EA75 C |
 IEA9A :                       EA9F C |  IEAA4 :                       EAA9 C |
 IEACF :                       EAD4 C |  IEB07 :                       EB10 C |
 IEB11 :                       EB1C C |  IEB2A :                       EB35 C |
 IEB2C :                       EB37 C |  IEB43 :                       EB4C C |
 IEB4D :                       EB56 C |  IEB53 :                       EB63 C |
 IEB5D :                       EB6E C |  IEB67 :                       EB7B C |
 IEB91 :                       ED0D C |  IEB9C :                       ED18 C |
 INCSIDE :                     E9C1 C |  INCTRK :                      E9D1 C |
*INEXTMODE :                      0 - | *INLWORDMODE :                    0 - |
*INMAXMODE :                      0 - | *INSRCMODE :                      0 - |
*INSUPMODE :                      0 - |  LDADDR :                        20 - |
*LDATA :                       EBE4 C | *LDATA1 :                      EBF2 C |
*LIST :                        EBCC C | *LISTON :                         1 - |
 LPDAT0EXT :                   EDE8 C |  LPDATEXT :                    EDDA C |
*LPINIT :                      EBC0 C |  LPINITEXT :                   EDB6 C |
 LPLISTEXT :                   EDC2 C |  LPTPIA0 :                     EC10 - |
 LPTPIA1 :                     EC11 - |  LPTPIA2 :                     EC12 - |
 LPTPIA3 :                     EC13 - |  LSCTLN :                         5 - |
 M0012 :                         12 - | *MACEXP :                         7 - |
*MEC10 :                       EC10 - | *MEC11 :                       EC11 - |
*MEC12 :                       EC12 - | *MEC13 :                       EC13 - |
*MOMCPU :                      6800 - | *MOMCPUNAME :                "6800" - |
*NESTMAX :                      100 - |  NMIISR :                      ED33 C |
 AS V1.42 Beta [Bld 216] - Source File floppy2_commented.asm - Page 22 - 02/21/2026 11:24:45 PM


 NMISVC :                      FFFC - |  NMIVECSAV :                      F - |
 NOCRC :                       EA0B C |  NUMSCTH :                        3 - |
 NUMSCTL :                        4 - |  NXTSEC :                      E9E3 C |
 ONECON :                        24 - | *OSLOAD :                      E800 C |
*PACKING :                        0 - | *PADDING :                        0 - |
 PIACTRL :                     EC02 - |  PIAREGA :                     EC00 - |
 PIAREGB :                     EC01 - |  PRNTE2 :                      E855 C |
 PRNTER :                      E85A C |  PROM_0 :                      FCFC - |
*RDCRC :                       E86F C |  READCRC :                     EAC2 C |
 READINIT :                    EB9B C | *READPS :                      E86D C |
 READSC :                      E869 C |  READSECT :                    EAA2 C |
 REENT2 :                      F564 - | *RELAXED :                        0 - |
 RESTOR :                      E875 C |  RESTORN :                     E901 C |
 RESTORY :                     E91B C |  RETRG :                       ED22 C |
*RWTEST :                      E872 C |  SE8EA :                       ED4D C |
 SE8FB :                       ED5E C |  SECRDDONE :                   E983 C |
 SECTCNT :                        B - | *SEEK :                        E878 C |
 SERR1 :                       EA8B C |  SERR2 :                       EA9A C |
 SERR3 :                       E8F0 C |  SERR4 :                       EA9D C |
 SERR6 :                       E8F3 C |  SERR7 :                       E942 C |
 SERR9 :                       EA8E C |  SETERR :                      ED3A C |
*SIDE0 :                       ED8B C |  SIDETWO :                     E9F0 C |
 SOFTRK :                         A - |  SSDA_0 :                      EC04 - |
 SSDA_1 :                      EC05 - |  STACKSAV :                      16 - |
 START :                       E9F5 C |  STATSAV :                        D - |
 STEP :                        E945 C |  STORE :                       E8D1 C |
 STPAGAIN :                    E92B C |  STRSCTH :                        1 - |
 STRSCTL :                        2 - | *TIME :               "11:24:45 PM" - |
*TOP :                         EB98 C |  TOPEXT :                      ED92 C |
 TRACKSAV :                      13 - | *TRUE :                           1 - |
 TWOSIDED :                    E8EC C | *VERSION :                     142F - |
 WAIT1 :                       E954 C |  WAIT2 :                       E95B C |
 WAIT3 :                       E952 C | *WRDDAM :                      E87E C |
 WRITINI2 :                    EAE2 C | *WRITSC :                      E884 C |
 WRITSEC :                     EB3C C | *WRTEST :                      E87B C |
*WRVERF :                      E881 C |  XOUTCH :                      F018 - |
 XSERR7 :                      ED38 C |  XSTAKS :                      FF8A - |
*Z80SYNTAX :                      0 - |  ZE84F :                       E84F C |
 ZE866 :                       E866 C |  ZE96A :                       E969 C |
 ZEB93 :                       EB93 C |  ZEB9E :                       ED98 C |
 ZEBB9 :                       EDB3 C |  ZEBD2 :                       EDC8 C |
 ZEBE2 :                       EDD8 C |  ZEBE6 :                       EDDC C |
 ZEBED :                       EDE3 C |

    197 symbols
     54 unused symbols

 AS V1.42 Beta [Bld 216] - Source File floppy2_commented.asm - Page 23 - 02/21/2026 11:24:45 PM


  Code Pages:
  ----------

STANDARD (0 changed characters)

1 code page

0.01 seconds assembly time

    916 lines source file
   1172 lines incl. macro expansions
      2 passes
      0 errors
      0 warnings
